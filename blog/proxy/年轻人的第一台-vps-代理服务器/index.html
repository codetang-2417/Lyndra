<!DOCTYPE html><html lang="zh-cn"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.png"><meta name="generator" content="Astro v5.7.13"><!-- Canonical URL --><link rel="canonical" href="https://www.hysling.top/blog/proxy/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0-vps-%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><link rel="alternate" type="application/rss+xml" title="Lyndra's Blog" href="/rss.xml"><!-- Primary Meta Tags --><meta name="title" content="年轻人的第一台 VPS 代理服务器 - Lyndra's Blog"><meta name="description" content="素处以默"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://www.hysling.top/blog/proxy/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0-vps-%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><meta property="og:title" content="年轻人的第一台 VPS 代理服务器 - Lyndra's Blog"><meta property="og:description" content="素处以默"><meta property="og:image" content="https://www.hysling.top/blog/proxy/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0-vps-%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><!-- <meta property="og:image:alt" content={site.description}/> --><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://www.hysling.top/blog/proxy/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0-vps-%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><meta property="twitter:title" content="年轻人的第一台 VPS 代理服务器 - Lyndra's Blog"><meta property="twitter:description" content="素处以默"><meta property="twitter:image" content="https://www.hysling.top/blog/proxy/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0-vps-%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="sitemap" href="/sitemap-0.xml"><title>年轻人的第一台 VPS 代理服务器 - Lyndra&#39;s Blog</title><script src="/toggle-theme.js"></script><script async type="text/javascript" src="/load-mathjax.js"></script><script async type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/mermaid/10.9.0/mermaid.min.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="/_astro/WalineComment.XaQ6XQsx.css">
<link rel="stylesheet" href="/_astro/BlogPost.BUYUBhIy.css">
<link rel="stylesheet" href="/_astro/about.gIe6_up2.css">
<link rel="stylesheet" href="/_astro/_slug_.DYqrg3Zi.css">
<style>#donate-item-img{filter:grayscale(1)}#donate-item-img:hover{filter:blur(0px);cursor:pointer}.esa-sponsor{position:relative;width:100%;margin:40px 0}.esa-sponsor .qrshow{position:absolute;width:200px;height:200px;cursor:pointer;left:calc(50% - 100px);top:-170px;z-index:999;display:none;box-shadow:0 1px 15px #1b1f2326,0 0 1px #6a737d59}
.post-title[data-astro-cid-6t6zfk7k]:hover{outline:0;color:#cc7a00;text-shadow:1px 1px 1px #ffd147}.toc_container[data-astro-cid-6t6zfk7k]{overflow-y:scroll;scrollbar-width:none;-ms-overflow-style:none}.toc_container[data-astro-cid-6t6zfk7k]::-webkit-scrollbar{width:0;height:0}.toc_container[data-astro-cid-6t6zfk7k] a[data-astro-cid-6t6zfk7k]{text-overflow:ellipsis;white-space:nowrap;overflow:hidden}
</style></head><body class="bg-skin-secondary"> <header class="fixed top-0 w-full bg-skin-fill text-skin-base z-10"> <div class="flex items-center justify-between container"> <div class="block xl:hidden"> <button type="button" id="menu-icon" class="header-btn" title="Menu"> <i class="ri-menu-fill"></i> </button> <button type="button" id="menu-icon-close" class="header-btn hidden" title="Menu"> <i class="ri-close-fill"></i> </button> <script type="module">let n=document.getElementById("menu-icon"),t=document.getElementById("menu-icon-close"),l=document.getElementById("mobile-menu"),e=document.getElementById("aside-btn"),i=document.getElementById("aside-close-btn"),s=document.getElementById("personal-info");n.addEventListener("click",()=>{e&&e.classList.contains("hidden")&&d([e,i,s]),d([n,t,l])});t.addEventListener("click",()=>{d([n,t,l])});function d(o){o.forEach(c=>{c.classList.toggle("hidden")})}</script> </div> <a class="text-2xl p-4" href="/">Lyndra&#39;s Blog</a> <div class="flex items-center"> <div class="hidden xl:block"> <div class="flex items-center space-x-5 pr-4"> <div class="box relative h-10 w-auto flex items-center" data-astro-cid-eimmu3lg> <a href="/blog/1" target="_self" class="header-link-active hover:header-link-hover" data-astro-cid-eimmu3lg> <i class="ri-draft-line" data-astro-cid-eimmu3lg></i> 博客  </a>  </div> <div class="box relative h-10 w-auto flex items-center" data-astro-cid-eimmu3lg> <a href="/feed/1" target="_self" class="hover:header-link-hover" data-astro-cid-eimmu3lg> <i class="ri-lightbulb-flash-line" data-astro-cid-eimmu3lg></i> 动态  </a>  </div> <div class="box relative h-10 w-auto flex items-center" data-astro-cid-eimmu3lg> <a href="/archive/1" target="_self" class="hover:header-link-hover" data-astro-cid-eimmu3lg> <i class="ri-archive-line" data-astro-cid-eimmu3lg></i> 归档  </a>  </div> <div class="box relative h-10 w-auto flex items-center" data-astro-cid-eimmu3lg> <a href="/message" target="_self" class="hover:header-link-hover" data-astro-cid-eimmu3lg> <i class="ri-chat-1-line" data-astro-cid-eimmu3lg></i> 留言  </a>  </div> <div class="box relative h-10 w-auto flex items-center" data-astro-cid-eimmu3lg> <a href="/search" target="_self" class="hover:header-link-hover" data-astro-cid-eimmu3lg> <i class="ri-search-line" data-astro-cid-eimmu3lg></i> 搜索  </a>  </div> <div class="box relative h-10 w-auto flex items-center" data-astro-cid-eimmu3lg> <a href="javascript:void(0);" target="_self" class="hover:header-link-hover" data-astro-cid-eimmu3lg> <i class="ri-more-fill" data-astro-cid-eimmu3lg></i> 更多 <i class="ri-arrow-down-s-line" data-astro-cid-eimmu3lg></i> </a> <div class="dropdown cursor-pointer border rounded bg-skin-fill p-4" data-astro-cid-eimmu3lg> <ul class="space-y-4 w-28" data-astro-cid-eimmu3lg> <li class="text-center hover:text-skin-active select-none" data-astro-cid-eimmu3lg> <i class="ri-information-line" data-astro-cid-eimmu3lg></i> <a target="_self" href="/about" data-astro-cid-eimmu3lg>关于本站</a> </li><li class="text-center hover:text-skin-active select-none" data-astro-cid-eimmu3lg> <i class="ri-user-5-line" data-astro-cid-eimmu3lg></i> <a target="_self" href="/friends" data-astro-cid-eimmu3lg>友情链接</a> </li> </ul> </div> </div>  </div> </div> <button type="button" id="theme-btn" class="header-btn" title="Toggles light & dark" aria-label="auto" aria-live="polite"> <i id="moon-icon" class="ri-sun-line"></i> <i id="sun-icon" class="ri-moon-line"></i> </button> <div class="block xl:hidden"> <button type="button" id="aside-btn" class="header-btn" title="Open Aside Bar" aria-label="auto" aria-live="polite"> <i class="ri-user-line"></i> </button> <button type="button" id="aside-close-btn" class="header-btn hidden" title="Close Aside Bar" aria-label="auto" aria-live="polite"> <i class="ri-close-fill"></i> </button> <div id="blog-aside" class="absolute top-16 bg-skin-fill right-0 blog-aside hidden"></div> <script type="module">let n=document.getElementById("aside-btn"),t=document.getElementById("aside-close-btn"),e=document.getElementById("menu-icon"),i=document.getElementById("menu-icon-close"),s=document.getElementById("mobile-menu"),l=document.getElementById("personal-info");n.addEventListener("click",()=>{e&&e.classList.contains("hidden")&&d([e,i,s]),d([n,t,l])});t.addEventListener("click",()=>{d([t,l,n])});function d(o){o.forEach(c=>{c.classList.toggle("hidden")})}</script> </div> </div> </div> <div id="mobile-menu" class="hidden text-center overflow-y-auto pb-8" style="height: calc(100vh - 64px)"> <div class="py-2"> <a class=" hover:text-skin-active" href="/blog/1"> <i class="ri-draft-line"></i> <span>博客</span> </a>  <div class="space-y-4 text-sm">  </div> </div><div class="py-2"> <a class=" hover:text-skin-active" href="/feed/1"> <i class="ri-lightbulb-flash-line"></i> <span>动态</span> </a>  <div class="space-y-4 text-sm">  </div> </div><div class="py-2"> <a class=" hover:text-skin-active" href="/archive/1"> <i class="ri-archive-line"></i> <span>归档</span> </a>  <div class="space-y-4 text-sm">  </div> </div><div class="py-2"> <a class=" hover:text-skin-active" href="/message"> <i class="ri-chat-1-line"></i> <span>留言</span> </a>  <div class="space-y-4 text-sm">  </div> </div><div class="py-2"> <a class=" hover:text-skin-active" href="/search"> <i class="ri-search-line"></i> <span>搜索</span> </a>  <div class="space-y-4 text-sm">  </div> </div><div class="py-2"> <a class=" hover:text-skin-active" href="javascript:void(0);"> <i class="ri-more-fill"></i> <span>更多</span> </a> <div class="divider-horizontal"></div> <div class="space-y-4 text-sm"> <a class="block hover:text-skin-active" href="/about"> <i class="ri-information-line"></i> <span>关于本站</span> </a><a class="block hover:text-skin-active" href="/friends"> <i class="ri-user-5-line"></i> <span>友情链接</span> </a> </div> </div> </div> <div id="personal-info" class="hidden break-all overflow-y-auto pb-8" style="height: calc(100vh - 64px)"> <img class="avatar my-4 mx-auto" src="/avatar.svg" alt="avatar"> <div class="mb-2 text-center">本来无一物，何处惹尘埃</div> <div class="flex items-center justify-center flex-wrap"> <a title="github" href="https://github.com/codetang-2417" target="_blank"> <i class="ri-github-fill text-2xl mr-2 cursor-pointer"></i> </a><a title="rss" href target="_blank"> <i class="ri-rss-fill text-2xl mr-2 cursor-pointer"></i> </a> </div> <div class="divider-horizontal-mini"></div> <div class="text-center"> <div> <i class="ri-folder-3-line menu-icon"></i>分类 </div> <div class="my-2 break-all truncate"> <a class="hover:text-skin-active" title="工具教程 (16)" href="/category/工具教程"> 工具教程 (16) </a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active" title="专业知识 (4)" href="/category/专业知识"> 专业知识 (4) </a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active" title="编程开发 (8)" href="/category/编程开发"> 编程开发 (8) </a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active" title="系统维护 (21)" href="/category/系统维护"> 系统维护 (21) </a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active" title="网络安全 (7)" href="/category/网络安全"> 网络安全 (7) </a> </div> <div class="divider-horizontal-mini"></div>
          <div class="text-center"> <i class="ri-price-tag-3-line menu-icon"></i> 标签 </div> <div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="AI" href="/tags/AI">AI (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="iPhone" href="/tags/iPhone">iPhone (2)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Performance" href="/tags/Performance">Performance (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Linux" href="/tags/Linux">Linux (17)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Manjaro" href="/tags/Manjaro">Manjaro (8)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Bash" href="/tags/Bash">Bash (2)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Server" href="/tags/Server">Server (8)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Network" href="/tags/Network">Network (4)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Hardware" href="/tags/Hardware">Hardware (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Astro" href="/tags/Astro">Astro (2)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Github" href="/tags/Github">Github (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Blog" href="/tags/Blog">Blog (3)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Siyuan" href="/tags/Siyuan">Siyuan (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Archlinux" href="/tags/Archlinux">Archlinux (2)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Shell" href="/tags/Shell">Shell (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Downgrade" href="/tags/Downgrade">Downgrade (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Cursor" href="/tags/Cursor">Cursor (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Git" href="/tags/Git">Git (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Ubuntu" href="/tags/Ubuntu">Ubuntu (6)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Markdown" href="/tags/Markdown">Markdown (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Hugo" href="/tags/Hugo">Hugo (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Github pages" href="/tags/Github pages">Github pages (1)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Algorithm" href="/tags/Algorithm">Algorithm (3)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Docker" href="/tags/Docker">Docker (5)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="VPS" href="/tags/VPS">VPS (3)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="Proxy" href="/tags/Proxy">Proxy (4)</a> </div><div class="my-2 break-all truncate"> <a class="hover:text-skin-active my-2" title="QEMU" href="/tags/QEMU">QEMU (3)</a> </div> </div> </div> </header> <main class="container p-4  pt-20 text-skin-base min-h-full pb-32 relative" id="app"> <div class="grid grid-cols-4 gap-8"> <div class="col-span-4 xl:col-span-3 space-y-4 first:space-y-2"> <button class="flex items-center text-md cursor-pointer hover:text-skin-active outline-none" style="background-color: inherit;" onclick="history.back()"> <i class="ri-arrow-left-line mr-2"></i> <span>返回</span> </button>  <div> <div> <!-- title --> <h1 class="break-all text-2xl font-bold">年轻人的第一台 VPS 代理服务器</h1> <div class="flex flex-wrap items-center my-2 text-skin-dodge"> <!-- date --> <div class="mr-2"><i class="ri-calendar-2-fill mr-1"></i>2024-12-20</div> <!-- draft -->  <!-- category --> <a href="/category/系统维护" class="text-wrap break-all hover:text-skin-active mr-2"><i class="ri-folder-3-line mr-1"></i>系统维护</a><a href="/category/网络安全" class="text-wrap break-all hover:text-skin-active mr-2"><i class="ri-folder-3-line mr-1"></i>网络安全</a> <!-- tag --> <a href="/tags/VPS" class="text-wrap break-all hover:text-skin-active mr-2"><i class="ri-hashtag mr-1"></i>VPS</a><a href="/tags/Proxy" class="text-wrap break-all hover:text-skin-active mr-2"><i class="ri-hashtag mr-1"></i>Proxy</a> <!-- update --> <!--{--> <!--  lastModified && (--> <!--    <div class="mr-2"><i class="ri-calendar-check-fill "></i>{t('post.lastUpdated')}:{lastModified}</div>--> <!--  )--> <!--}--> <!-- minutes --> <div class="mr-2 flex items-center"><i class="ri-hourglass-fill mr-1"></i>50分钟</div>
        <div class="mr-2 flex items-center"><i class="ri-quill-pen-line mr-1"></i>9820字</div> </div>  </div> <div class="divider-horizontal"></div> <article class="markdown-body"> <h1 id="年轻人的第一台-vps-代理服务器">年轻人的第一台 VPS 代理服务器</h1>
<h2 id="免责声明">免责声明</h2>
<p>　　本文涉及的任何解锁和解密分析脚本仅用于资源共享和学习研究，不能保证其合法性，准确性，完整性和有效性，请根据情况自行判断。</p>
<p>　　间接使用脚本的任何用户，包括但不限于建立VPS或在某些行为违反国家/地区法律或相关法规的情况下进行传播, 本文作者对于由此引起的任何隐私泄漏或其他后果概不负责。</p>
<p>　　请勿将本文内的任何内容用于商业或非法目的，否则后果自负。</p>
<p>　　如果任何单位或个人认为该项目的脚本可能涉嫌侵犯其权利，则应及时通知并提供身份证明，所有权证明，我将在收到认证文件后删除相关脚本。</p>
<p>　　对任何本文中包含的脚本在使用中可能出现的问题概不负责，包括但不限于由任何脚本错误导致的任何损失或损害．</p>
<p>　　您必须在下载后的24小时内从计算机或手机中完全删除以上内容。</p>
<p>　　任何以任何方式查看此项目的人或直接或间接使用该项目的任何脚本的使用者都应仔细阅读此声明。本文作者保留随时更改或补充此免责声明的权利。一旦使用并复制了任何本文相关脚本或其他内容，则视为您已接受此免责声明。</p>
<h2 id="实现的功能">实现的功能</h2>
<ol>
<li>搭建一个稳定的代理服务器。</li>
<li>提供便捷的订阅转换服务，便于分享节点信息。可供 3-4 人使用。</li>
<li>能够访问 ChatGPT，VPS 的 IP 最好是原生 IP，访问一些特殊网站时不会被 block。</li>
<li>提供的对外服务要够安全。例如，xray 面板需要以 TLS 加密访问，不能 http 裸奔在公网、SSH 服务更改端口，限制 root 用户登陆、节点使用当前较为安全的的协议等。</li>
<li>有 IPV6，平时有使用 BT、 PT 的需求。</li>
</ol>
<p>　　基于上述功能，本教程搭建的 VPS 有如下特点：</p>
<ol>
<li>选用原生 IP 的 VPS 提供商，价格在 20 刀一年左右。能解锁 GPT。</li>
<li>购买域名，使用 cloudflare 解析 DNS，申请 TLS 证书，使得域名能够提供 https 安全访问。</li>
<li>使用 nginx 分流、反代本服务器上的代理服务、订阅服务、伪装服务。</li>
<li>使用 x-ui 面板搭建 vless+tls+vision 节点；搭建 hysteria2 节点。</li>
<li>搭建 sub-store，提供前后端订阅转换、分享服务，提供第三方网盘、glist 同步服务。</li>
</ol>
<p>　　本教程并非面向纯小白用户，如果你对基础的 Linux 命令不懂，对简单计算机网络知识不懂，建议不要尝试。如果你真的想尝试，并且愿意花时间学习，可以先购买机场，完成科学上网第一步。</p>
<p>　　在 youtube 上学习科学上网基本知识，推荐不良林：<a href="https://www.youtube.com/@bulianglin">www.youtube.com/@bulianglin</a></p>
<p>　　再结合 <a href="https://xtls.github.io/">Project X</a> 项目的文档 <a href="https://xtls.github.io/document/level-0/ch01-preface.html">小小白白话文</a> 对照阅读。遇到不明白的知识去问 GPT，大概率能得到一个清晰的答案；或者 google 搜索对应知识。</p>
<p>　　<strong>本教程在 Linux 系统下完成。</strong></p>
<h2 id="前期准备">前期准备</h2>
<h3 id="购买域名">购买域名</h3>
<p>　　域名一般都推荐 namesilo，购买一些便宜点的域名，例如 top，一年只要不到 2 美金，续费基本在 5 美金左右。如果嫌续费贵，大可以在到期以后，重新买一个便宜域名，然后再更新 DNS 解析，和节点信息。</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20241224151440-ivm7aes.png" data-alt="image">​</p>
<p>　　购买后需要将 DNS 服务换成 Cloudflare，参考：<a href="https://sarakale.top/blog/posts/3a730d01/">Namesilo/Cloudflare 域名注册和解析设置教程</a>，便于后续申请 TLS 证书。申请合法的 TLS 证书非常重要，避免你的 VPS 用 http 访问，数据裸奔在公网，指不定哪天就被黑了。</p>
<h3 id="dns-解析">DNS 解析</h3>
<p>　　当你购买域名，并按照上述参考将域名解析托管到 clouflare 后，就可以设置 DNS 解析了。你可以设置无限多的三级域名，解析到不同的 IP，用作不同的用途。</p>
<p>　　需要注意，这里有一个代理状态栏，如果开启代理，则解析 DNS 时，会解析到 cloudflare 的 CDN IP，而不是自己设置的服务器 IP。该 CDN 会转发请求到服务器，但默认只会转发 443 端口的内容，不过你可以设置 Origin Rules 在 CDN 转发时，转发到服务器指定的端口上。</p>
<p>　　后续的节点搭建会要求设置不同的三级域名，解析到服务器 IP，以识别不同的服务。有一些不需要设置代理，有一些则需要设置代理以提高服务的安全性。</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20250108165105-3iwhef6.png" data-alt="image">​</p>
<p>　　‍</p>
<h3 id="购买-vps">购买 VPS</h3>
<p>　　经典的 VPS 推荐环节，但由于咱们的情况特殊，一旦有人推荐一些好用的 VPS，或者可以薅羊毛的 VPS，不出多久，就会有大量的用户滥用，导致原有的用户体验下降，或者 IP 段被 GFW 特殊照顾。因此，不给出目前自用的 VPS 推荐。也不给 VPS <strong>长期</strong>购买建议。</p>
<p>　　补充：这个网站 <a href="https://vpsls.com/docs/%E9%A6%96%E9%A1%B5/">vpsIs</a> 罗列了许多VPS 厂家，以及其目前的订购费用，可以按需自选。</p>
<p>　　此处仅仅列出一些目前比较有名的境外 VPS 厂家：</p>
<ol>
<li>BandwagonHost，板瓦工，国内出名的厂家，用的人很多，所以普通线路的质量可能会差点（没用过，仅供参考），C2N 线路的据说速度很快。IP 被封可以给钱换机器。普通机器 50💲 一年，对于个人用户来说小贵。</li>
<li>VULTR，小时计费，速度一般，可以用来练手，ip 被封可以直接删除实例，重开一台其他地方的机器。便宜的大概 6💲一月，也有 3、4💲一月的，但几乎买不到。</li>
<li>RackNerd，最近两年好像很火，也属于便宜的那一档。</li>
<li>CloudCone，了解不多。</li>
<li>DMIT，了解不多。</li>
</ol>
<p>　　除了费用、网络质量外，我们还需要关心：是否有 ipv6、是否支持 GPT 访问（网页端、移动端）。</p>
<p>　　IPV6 一般都会提供，不需要额外费用。</p>
<p>　　但是否支持 GPT 则是看 IP 是否“安全”。主要指的是 风控值，例如之前我在 vultr 购买的波兰服务器</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20241224155112-k7bv01g.png" data-alt="image">​</p>
<p>　　现在使用的机器</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20241224155155-k9m2f2c.png" data-alt="image">​</p>
<p>　　所以，vultr 的波兰 VPS 只支持网页端访问，还会经常弹出 cloudflare 的人机验证。而现在的机器直接可以支持 app 访问。当然 GPT 是否能访问也根据地区有关，我没有仔细测试过，只是说明，在挑选 VPS 的时候尽可能的在网上搜索看看是否支持 GPT 的访问。</p>
<p>　　当然，如果你购买的机器不支持，也可以通过 warp 等手段解锁。</p>
<h3 id="安装终端软件">安装终端软件</h3>
<p>　　如果你也用 Linux，可以略过这一步。</p>
<p>　　使用 windows 的用户推荐安装 termius（全平台可用），免费功能足够了。ssh 登陆，sftp 传输文件非常方便，并且 UI 很好看。其也有移动端 app，我有时会通过手机端登陆上服务器看看情况。</p>
<p>　　官网地址：<a href="https://termius.com/">termius.com/</a></p>
<h2 id="方案选择">方案选择</h2>
<p>　　经过对目前主流的代理协议调查，决定同时搭建两种协议：hysteria2、vless+vision。前者基于 udp 传输、伪装成 http3 流量；后者则是为了解决 tls in tls 问题而推出的一种缓解该特征的方式。只能保证当前时刻，两者用来代理是稳定的。声明：没有最好的协议，只有最适合自己的协议。</p>
<p>　　在搭建上述两种协议时，涉及到 x-ui 面版和 nginx 的使用。为了使服务尽可能的稳定，x-ui 面板启用 https，而 hysteria2 需要在 80 和 443 端口进行伪装，所以要用 nginx 在 443 端口对 x-ui 流量和 hysteria2 的伪装流量分流。</p>
<p>　　除了代理服务，还有订阅服务。目前网络上主要两种：sub converter 和 sub-store。</p>
<p>　　sub converter 的官方支持较慢，例如：clash 原版删除跑路后，clash.meta 继续维护，但改动较大，截止目前 sub converter 官方版本仍未支持 meta 内核的新协议；在 hysteria2 出现 1 年后，其支持才被合并到官方主枝。但即使如此，并不影响其作为一款优秀的订阅转换工具，因为上述的兼容问题，有各种魔改版本来解决，比如 meta 内核官方自己基于 sub converter 开发了支持 meta 协议版本（<a href="https://github.com/MetaCubeX/subconverter">github.com/MetaCubeX/subconverter</a>）。还有一个重要的原因是，clash 系列、sing-box 等部分软件，配置文件不仅仅需要节点信息，还需要软件配置信息才能正常运行，sub converter 在转换时，可以同时给出配置信息。大部分的机场订阅都是使用 sub converter。例如，曾经使用的一个机场就是用免费的订阅转换工具 <a href="https://sub.v1.mk/">sub.v1.mk</a> 来转换其搭建的 v2ray 节点。这里要注意：所有的订阅工具，都可以在后台看到你使用的节点转换信息。所以不能保证所有的搭建者都不去浏览抓换的节点信息。</p>
<p>　　sub-store 则更新维护比较及时，也有前后端界面，区别在于，sub-store 转换节点信息比较方便，但要转换 clash 系列、sing-box 等部分软件时麻烦一些。好处是 sub-store 有更为完善的数据保存同步功能，你可以把你的配置同步到 glist。</p>
<p>　　本教程采用 sub-store 来管理订阅。sub converter 我也做过尝试，但因为其订阅管理不够方便，仍然需要搭配 sub-store 来使用、转换 hysteria2 还有 passwd 不兼容问题，最终作罢。</p>
<p>　　下面是这些服务共存在一台服务器上时，使用 nginx 进行端口分流时拓扑图。</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx-Rules-20241224161539-5iq1no8.png" data-alt="Nginx-Rules">​</p>
<h2 id="服务器购买">服务器购买</h2>
<p>　　当前服务器 20 💲一年，原生 ip，支持 gpt 网页和移动端，不支持 Netflix 非自制剧。</p>
<p>　　使用 debian 12系统，ubuntu 的操作应该也类似。</p>
<h2 id="整体框架">整体框架</h2>
<p>　　搭建步骤分为几步：</p>
<ol>
<li>防火墙设置</li>
<li>申请域名证书</li>
<li>节点搭建-hysteria2</li>
<li>节点搭建-vless+vision</li>
<li>搭建 sub-store 服务</li>
<li>Nginx 分流隐藏服务</li>
</ol>
<h2 id="服务器搭建">服务器搭建</h2>
<h3 id="服务器-ssh-服务安全加固">服务器 ssh 服务安全加固</h3>
<p>　　购买服务器后，供应商会给 root 用户和密码，或者让你上传 ssh key，然后通过 ssh 访问服务器。</p>
<p>　　ssh 连接到服务器后，就可以对服务器的基础安全性进行加固。</p>
<h4 id="安装常用软件">安装常用软件</h4>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.r9qfg.css"><script type="module" src="/_astro/ec.dy9ns.js"></script><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">update</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">apt-get</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-y</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">vim</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">ufw</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="apt update &#x26;&#x26; apt-get install -y curl vim ufw"><div></div></button></div></figure></div>
<p>　　后续会使用 curl 下载各种脚本，vim 编辑文件（不熟悉的可以替换为 nano），iptables-persistent 管理网络防火墙。<br>
注：部分 vps 提供商有自己的防火墙管理面板，仅仅在 vps 中更改可能不生效。吐槽一下甲骨文的 vps 面板是真的难用，试用了一下直接劝退。</p>
<h4 id="建立非-root的新用户">建立【非 root】的新用户</h4>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">list</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--upgradable</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">update</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">apt-get</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-y</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sudo</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">getent</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">group</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1001</span><span style="--0:#F97583;--1:#BF3441">||</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">groupadd</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-g</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1001</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">vps</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">\</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">&#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">getent</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">passwd</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">username</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">||</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">useradd</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-ms</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/bin/bash</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-u</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1001</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-g</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1001</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-G</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">username</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">\</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">&#x26;&#x26; </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"username:passwd"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">chpasswd</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"username ALL=(ALL) NOPASSWD:ALL"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">>></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/sudoers</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="apt list --upgradable apt update &#x26;&#x26; apt-get install -y sudogetent group 1001|| groupadd -g 1001 vps \    &#x26;&#x26; getent passwd username || useradd -ms /bin/bash -u 1001 -g 1001 -G sudo username \    &#x26;&#x26; echo &#x22;username:passwd&#x22; | chpasswdecho &#x22;username ALL=(ALL) NOPASSWD:ALL&#x22; >> /etc/sudoers"><div></div></button></div></figure></div>
<p>　　上述命令的含义为：1. 安装 sudo，管理 root 权限。 2. 创建用户名为 username 的用户，密码为 passwd；并将其加入到 root 用户组，且使用 sudo 时不需要输入密码。</p>
<p>　　设置好后，另起一个终端，使用用户 username 登陆尝试一下是否建立成功。</p>
<p>　　注：上述用户名和密码请自行替换为自己的。后续同理。</p>
<h4 id="修改-ssh-登陆端口">修改 ssh 登陆端口</h4>
<p>　　注意命令执行顺序，先放行 ssh，再启动 ufw，并未验证 ufw 的默认配置会不会放行 ssh（虽说应该会考虑到），千万别把自己也挡在防火墙外了。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">apt-get</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">ufw</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">allow</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">ssh</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">enable</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">allow</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1111</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">vim</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/ssh/sshd_config</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># 修改 PORT 为1111</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">restart</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">ssh</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo apt-get install ufwsudo ufw allow sshsudo ufw enablesudo ufw allow 1111sudo vim /etc/ssh/sshd_config # 修改 PORT 为1111sudo systemctl restart ssh"><div></div></button></div></figure></div>
<p>　　上述命令，编辑 ssh 配置文档 <code>/etc/ssh/sshd_config</code>​ 修改其访问端口为 1111，并使用 ufw 管理防火墙，放行 1111 端口。</p>
<p>　　注：自行修改为自己想用的端口。</p>
<h4 id="禁用-root-用户-ssh-远程登录">禁用 root 用户 SSH 远程登录</h4>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">vim</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/ssh/sshd_config</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># PermitRootLogin yes 改为 no</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="vim /etc/ssh/sshd_config # PermitRootLogin yes 改为 no"><div></div></button></div></figure></div>
<h4 id="ssh-启用-rsa-密钥验证登录">SSH 启用 RSA 密钥验证登录</h4>
<p>　　参考：<a href="https://xtls.github.io/document/level-0/ch04-security.html#_4-7-%E4%BD%BF%E7%94%A8-rsa-%E5%AF%86%E9%92%A5%E7%99%BB%E5%BD%95%E5%B9%B6%E7%A6%81%E7%94%A8%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95">使用-rsa-密钥登录并禁用密码登录</a></p>
<p>　　在<strong>本机</strong>上单独开启一个终端，执行下列操作，允许 VPS 服务器接受本机的 ssh 密钥登陆请求。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">ssh-keygen</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># 一路回车，在 ~/.ssh 目录下生成公钥和私钥</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">ssh-copy-id</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1111</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">useranem@ip</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># 上传公钥到服务器</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="ssh-keygen # 一路回车，在 ~/.ssh 目录下生成公钥和私钥ssh-copy-id -p 1111 useranem@ip # 上传公钥到服务器"><div></div></button></div></figure></div>
<p>　　完成上述全部操作后，登陆 VPS，并禁用 22 端口</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">ssh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1111</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">username@ip</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">deny</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">22</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="ssh -p 1111 username@ipsudo ufw deny 22"><div></div></button></div></figure></div>
<h3 id="为你的域名申请-tls-证书">为你的域名申请 TLS 证书</h3>
<p>　　参考：<a href="https://blog.uuphy.com/posts/%E9%85%8D%E7%BD%AE-acme.sh-%E5%85%8D%E8%B4%B9%E8%87%AA%E5%8A%A8%E7%AD%BE%E5%8F%91%E6%B3%9B%E5%9F%9F%E5%90%8D%E8%AF%81%E4%B9%A6/">使用 acme.sh DNS 验证的方式签发 Let’sEncrypt 证书 </a></p>
<p>　　本教程后续依赖于有 tls 证书验证的域名，务必完成。</p>
<p>　　<a href="https://acme.sh">acme.sh</a> 是一个用来自动获取和管理 SSL/TLS 证书的开源脚本，可以从 Let’s Encrypt 等多个 CA 获取免费的证书。结合使用 Cloudflare DNS 验证的模式申请泛域名证书，并自动续签。</p>
<p>　　在前面购买域名后，已经使用过 Cloudflare 解析域名到 VPS 服务器的 IP 地址了。下面还需要用 Cloudflare 帮助验证域名的有效性，结合 Let’sEncrypt 自动申请和续签证书。</p>
<h4 id="cloudflare-api">Cloudflare API</h4>
<p>　　使用 Cloudflare DNS 模式需要准备:</p>
<ol>
<li>Zone ID</li>
<li>Account ID</li>
<li>API Token</li>
</ol>
<h5 id="获取-zone-id-account-id">获取 Zone ID, Account ID</h5>
<p>　　这两种 ID 直接在 Overview 页就能找到。</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20241218213828-6d2wfi7.png" data-alt="image">​</p>
<h5 id="获取-api-token">获取 API Token</h5>
<p>　　Overview 页点击 <code>获取您的 API 令牌</code>​ 进入 API Tokens 页。</p>
<p>　　点击 API Tokens 项旁边 <code>创建令牌</code>​ 按钮，接着选择 <code>编辑区域 DNS</code>​ 的模板，点击 <code>使用模板</code>​。</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20241218214029-7vpbrxm.png" data-alt="image">​</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20241218214133-uy0pzam.png" data-alt="image">​</p>
<p>　　​<code>区域资源</code>​ 里选择需要签发的域名</p>
<p>　　在 <code>客户端 IP 地址筛选</code>​ 里建议写下 acme.sh 所在的主机做为白名单，需要注意，如果服务器有 ipv6 地址，则也需要添加，因为有可能会 ipv6 优先访问。</p>
<p>　　击 <code>继续以显示摘要</code>​, 确认没问题后最后点击 <code>创建令牌</code>​。
<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20241218214624-pppnyya.png" data-alt="image">​</p>
<p>　　此时就会出现一个 Token,，即 CF_Token，拷贝备用。</p>
<p><img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20241218214832-6y5b95r.png" data-alt="image">​</p>
<h4 id="安装脚本">安装脚本</h4>
<p>　　后续申请证书的命令，都是在 root 用户下执行的，请先使用 <code>su</code>​ 切换到 root 用户。</p>
<p>　　安装脚本，设置 letsencrypt 为默认认证服务商，并设置邮箱用来接受 Let’s Encrypt 的邮件通知。安装时，acme 会自动的启动 cron 任务，每天检查是否需要续签证书。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">su</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># 进入root用户</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">https://get.acme.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-s</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">email=name@gmail.com</span><span style="--0:#E1E4E8;--1:#24292E">; </span><span style="--0:#B392F0;--1:#6F42C1">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">socat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-y</span><span style="--0:#E1E4E8;--1:#24292E">; </span><span style="--0:#B392F0;--1:#6F42C1">~/.acme.sh/acme.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--set-default-ca</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--server</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">letsencrypt</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="su # 进入root用户curl https://get.acme.sh | sh -s email=name@gmail.com; apt install socat -y; ~/.acme.sh/acme.sh --set-default-ca --server letsencrypt"><div></div></button></div></figure></div>
<h5 id="安装后的设置">安装后的设置</h5>
<p>　　安装完毕后重新加载 bash，自动启用 acme 设置的环境变量，可以直接输入 acme.sh 而无需输入路径。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#79B8FF;--1:#005CC5">source</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">~/.bashrc</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="source ~/.bashrc"><div></div></button></div></figure></div>
<p>　　开启自动更新</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">acme.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--upgrade</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--auto-upgrade</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="acme.sh --upgrade --auto-upgrade"><div></div></button></div></figure></div>
<p>　　设置环境变量, 也就是准备的那三样, 可以准备好在一个文本编辑器里, 拷贝粘贴依次执行:</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> CF_Token</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"&#x3C;拷贝的 API Token>"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> CF_Account_ID</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"&#x3C;拷贝的 Account ID>"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> CF_Zone_ID</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"&#x3C;拷贝的 Zone ID>"</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="export CF_Token=&#x22;<拷贝的 API Token>&#x22;export CF_Account_ID=&#x22;<拷贝的 Account ID>&#x22;export CF_Zone_ID=&#x22;<拷贝的 Zone ID>&#x22;"><div></div></button></div></figure></div>
<h4 id="使用-cloudflare-dns-验证签发证书">使用 Cloudflare DNS 验证签发证书</h4>
<h5 id="将-ca-服务器改成-lets-encrypt">将 CA 服务器改成 Let’s Encrypt</h5>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">acme.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--set-default-ca</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--server</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">letsencrypt</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="acme.sh --set-default-ca --server letsencrypt"><div></div></button></div></figure></div>
<h5 id="开始签发证书">开始签发证书</h5>
<p>　　使用 DNS 的方式申请不需要放行 80 443 端口。</p>
<p>　　这里以 hyperdns.com 为例，-d 后面接上域名, 可以签发多个，这里签了二级域名(<code>hyperdns.com</code>​) 和所有三级域名(<code>*.hyperdns.com</code>​)，并指定生成的证书位置为用户名为 username 的家目录下。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">acme.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--issue</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--dns</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">dns_cf</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-d</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hyperdns.com</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-d</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">*</span><span style="--0:#9ECBFF;--1:#032F62">.hyperdns.com</span><span style="--0:#E1E4E8;--1:#24292E">          </span><span style="--0:#79B8FF;--1:#005CC5">\</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">--key-file       </span><span style="--0:#9ECBFF;--1:#032F62">/home/username/hyperdns.com.key</span><span style="--0:#E1E4E8;--1:#24292E">                  </span><span style="--0:#79B8FF;--1:#005CC5">\</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">--fullchain-file </span><span style="--0:#9ECBFF;--1:#032F62">/home/username/fullchain.cer</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">\</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">--reloadcmd </span><span style="--0:#9ECBFF;--1:#032F62">'bash -c "nginx -s reload &#x26;&#x26; x-ui restart"'</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="acme.sh --issue --dns dns_cf -d hyperdns.com -d *.hyperdns.com          \--key-file       /home/username/hyperdns.com.key                  \--fullchain-file /home/username/fullchain.cer \--reloadcmd &#x27;bash -c &#x22;nginx -s reload &#x26;&#x26; x-ui restart&#x22;&#x27;"><div></div></button></div></figure></div>
<p>　　上述命令含有 <code>--reloadcmd</code> 参数，目的是在每次更新证书后，重启相关的服务。在此时由于 x-ui 和 nginx 还没有安装，执行命令会出错，但不妨碍证书的申请，此处可以忽略。</p>
<p>　　需要注意，如果出现错误，需要找到错误原因后，再进行下一步，否则错误次数过多，会触发 letsencrypt 速率限制，一段时间内将无法继续验证。（请注意，完整替换域名，这里演示的 .com 的一级域名，如果只改了一级域名，二级域名不对，将会一直验证，不会成功获取证书。一般的验证5分钟以内就可以完成，如果长时间都不成功，可能就是没有完整替换域名为你自己的域名）。</p>
<p>　　成功后，会给出证书的位置，如果不指定位置，则一般位于 <code>~/.acme.sh/域名_ecc/</code>​。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">-----END</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">CERTIFICATE-----</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Wed Dec </span><span style="--0:#79B8FF;--1:#005CC5">18</span><span style="--0:#E1E4E8;--1:#24292E"> 10:07:05 PM CST 2024] Your cert is in: /home/username/hyperdns.com.cer</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Wed Dec </span><span style="--0:#79B8FF;--1:#005CC5">18</span><span style="--0:#E1E4E8;--1:#24292E"> 10:07:05 PM CST 2024] Your cert key is in: /home/username/hyperdns.com.key</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Wed Dec </span><span style="--0:#79B8FF;--1:#005CC5">18</span><span style="--0:#E1E4E8;--1:#24292E"> 10:07:05 PM CST 2024] The intermediate CA cert is in: /home/username/ca.cer</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Wed Dec </span><span style="--0:#79B8FF;--1:#005CC5">18</span><span style="--0:#E1E4E8;--1:#24292E"> 10:07:05 PM CST 2024] And the full-chain cert is in: /home/username/fullchain.cer</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="-----END CERTIFICATE-----[Wed Dec 18 10:07:05 PM CST 2024] Your cert is in: /home/username/hyperdns.com.cer[Wed Dec 18 10:07:05 PM CST 2024] Your cert key is in: /home/username/hyperdns.com.key[Wed Dec 18 10:07:05 PM CST 2024] The intermediate CA cert is in: /home/username/ca.cer[Wed Dec 18 10:07:05 PM CST 2024] And the full-chain cert is in: /home/username/fullchain.cer"><div></div></button></div></figure></div>
<h5 id="验证自动续签">验证自动续签</h5>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">$</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">crontab</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-l</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">23</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">9</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">*</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">*</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">*</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/root/.acme.sh"/acme.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--cron</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--home</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/root/.acme.sh"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/dev/null</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ crontab -l23 9 * * * &#x22;/root/.acme.sh&#x22;/acme.sh --cron --home &#x22;/root/.acme.sh&#x22; > /dev/null"><div></div></button></div></figure></div>
<p>　　表示每天的上午9:23执行一次。检查是否需要更新证书。</p>
<p>　　手动执行：</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">$</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">acme.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--cron</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--home</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/root/.acme.sh</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Thu Dec </span><span style="--0:#79B8FF;--1:#005CC5">19</span><span style="--0:#E1E4E8;--1:#24292E"> 09:51:00 AM CST 2024] ===Starting cron</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">==</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Thu Dec </span><span style="--0:#79B8FF;--1:#005CC5">19</span><span style="--0:#E1E4E8;--1:#24292E"> 09:51:00 AM CST 2024] Renewing: </span><span style="--0:#9ECBFF;--1:#032F62">'hex.hyperdns.com'</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Thu Dec </span><span style="--0:#79B8FF;--1:#005CC5">19</span><span style="--0:#E1E4E8;--1:#24292E"> 09:51:00 AM CST 2024] Renewing using Le_API</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">https://acme-v02.api.letsencrypt.org/directory</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Thu Dec </span><span style="--0:#79B8FF;--1:#005CC5">19</span><span style="--0:#E1E4E8;--1:#24292E"> 09:51:00 AM CST 2024] Skipping. Next renewal </span><span style="--0:#F97583;--1:#BF3441">time</span><span style="--0:#E1E4E8;--1:#24292E"> is: 2025-02-08T09:00:33Z</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Thu Dec </span><span style="--0:#79B8FF;--1:#005CC5">19</span><span style="--0:#E1E4E8;--1:#24292E"> 09:51:00 AM CST 2024] Add </span><span style="--0:#9ECBFF;--1:#032F62">'--force'</span><span style="--0:#E1E4E8;--1:#24292E"> to force renewal.</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Thu Dec </span><span style="--0:#79B8FF;--1:#005CC5">19</span><span style="--0:#E1E4E8;--1:#24292E"> 09:51:00 AM CST 2024] Skipped hex.hyperdns.com_ecc</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Thu Dec </span><span style="--0:#79B8FF;--1:#005CC5">19</span><span style="--0:#E1E4E8;--1:#24292E"> 09:51:00 AM CST 2024] Renewing: </span><span style="--0:#9ECBFF;--1:#032F62">'hyperdns.com'</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Thu Dec </span><span style="--0:#79B8FF;--1:#005CC5">19</span><span style="--0:#E1E4E8;--1:#24292E"> 09:51:00 AM CST 2024] Renewing using Le_API</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">https://acme-v02.api.letsencrypt.org/directory</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Thu Dec </span><span style="--0:#79B8FF;--1:#005CC5">19</span><span style="--0:#E1E4E8;--1:#24292E"> 09:51:00 AM CST 2024] Skipping. Next renewal </span><span style="--0:#F97583;--1:#BF3441">time</span><span style="--0:#E1E4E8;--1:#24292E"> is: 2025-02-15T14:07:05Z</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Thu Dec </span><span style="--0:#79B8FF;--1:#005CC5">19</span><span style="--0:#E1E4E8;--1:#24292E"> 09:51:00 AM CST 2024] Add </span><span style="--0:#9ECBFF;--1:#032F62">'--force'</span><span style="--0:#E1E4E8;--1:#24292E"> to force renewal.</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">12</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Thu Dec </span><span style="--0:#79B8FF;--1:#005CC5">19</span><span style="--0:#E1E4E8;--1:#24292E"> 09:51:00 AM CST 2024] Skipped hyperdns.com_ecc</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">13</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">[Thu Dec </span><span style="--0:#79B8FF;--1:#005CC5">19</span><span style="--0:#E1E4E8;--1:#24292E"> 09:51:00 AM CST 2024] ===End cron</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">==</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ acme.sh --cron --home /root/.acme.sh[Thu Dec 19 09:51:00 AM CST 2024] ===Starting cron===[Thu Dec 19 09:51:00 AM CST 2024] Renewing: &#x27;hex.hyperdns.com&#x27;[Thu Dec 19 09:51:00 AM CST 2024] Renewing using Le_API=https://acme-v02.api.letsencrypt.org/directory[Thu Dec 19 09:51:00 AM CST 2024] Skipping. Next renewal time is: 2025-02-08T09:00:33Z[Thu Dec 19 09:51:00 AM CST 2024] Add &#x27;--force&#x27; to force renewal.[Thu Dec 19 09:51:00 AM CST 2024] Skipped hex.hyperdns.com_ecc[Thu Dec 19 09:51:00 AM CST 2024] Renewing: &#x27;hyperdns.com&#x27;[Thu Dec 19 09:51:00 AM CST 2024] Renewing using Le_API=https://acme-v02.api.letsencrypt.org/directory[Thu Dec 19 09:51:00 AM CST 2024] Skipping. Next renewal time is: 2025-02-15T14:07:05Z[Thu Dec 19 09:51:00 AM CST 2024] Add &#x27;--force&#x27; to force renewal.[Thu Dec 19 09:51:00 AM CST 2024] Skipped hyperdns.com_ecc[Thu Dec 19 09:51:00 AM CST 2024] ===End cron==="><div></div></button></div></figure></div>
<h4 id="使用">使用</h4>
<p>　　使用时，往往会要求填入证书和秘钥，这里注意，生成证书时，会有三种，在上述例子中，</p>
<ul>
<li><strong>hyperdns.com.cer</strong>：只有域名的叶子证书。</li>
<li><strong>ca.cer</strong>：中间证书，用来构建完整的信任链。</li>
<li><strong>fullchain.cer</strong>：由域名证书与中间证书组合而成的完整证书链文件，配置服务器时常用此文件以确保客户端能正确验证证书链。</li>
</ul>
<p>　　通常，采用 <strong>fullchain.cer</strong> 作为网站证书的配置。密钥只有一个，例如：<strong>hyperdns.com.key</strong>，对应域名证书的私钥，直接输入就行。</p>
<p>　　该证书会作为 hysteria2、x-ui、nginx使用。</p>
<p>　　由于目前在 root 用户下操作，默认的证书文件的权限仅 root 用户访问，因此需要修改。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 在 acme 申请命令时，已经将默认路径修改为相应路径，则不需要执行 cp 拷贝命令。</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">cp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/root/.acme.sh/hyperdns.com_ecc/hyperdns.com.key</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/home/username/hyperdns.com.key</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">cp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/root/.acme.sh/hyperdns.com_ecc/fullchain.cer</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/home/username/fullchain.cer</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">chmod</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">644</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/home/username/hyperdns.com.key</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">chmod</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">644</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/home/username/fullchain.cer</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="cp /root/.acme.sh/hyperdns.com_ecc/hyperdns.com.key /home/username/hyperdns.com.keycp /root/.acme.sh/hyperdns.com_ecc/fullchain.cer /home/username/fullchain.cersudo chmod 644 /home/username/hyperdns.com.keysudo chmod 644 /home/username/fullchain.cer"><div></div></button></div></figure></div>
<h2 id="节点搭建">节点搭建</h2>
<p>　　<strong>注意</strong>：后续所有节点均使用的是三级域名，在 cloudflare 解析 DNS 时，都不勾选 代理。因为 hysteria2 和 vless+vision 都不支持 cdn。全部都是直连。但提供订阅或者面板访问的域名，需要打开代理，提高一些安全性。</p>
<p>　　<strong>注：由于 x-ui 在生成节点时，如果面板配置有域名，则会自动将 server 处填写为 xui 的域名。但是 dns 解析时，为 xui 的域名勾选了代理，这会导致节点无法连接，因为此次搭建的节点都不支持 cdn。需要在使用时，手动将 xui 域名改为 直连的域名。</strong></p>
<h3 id="搭建和配置-hysteria2">搭建和配置 hysteria2</h3>
<p>　　同样在root权限下完成。命令 <code>su</code>​</p>
<h4 id="官网脚本安装">官网脚本安装</h4>
<p>　　官网地址：<a href="https://v2.hysteria.network/zh/">v2.hysteria.network/zh/</a>，可查看其配置说明。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">bash</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;(</span><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">-fsSL</span><span style="--0:#9ECBFF;--1:#032F62"> https://get.hy2.sh/)</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="bash <(curl -fsSL https://get.hy2.sh/)"><div></div></button></div></figure></div>
<p>　　如果出现</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">$</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">bash</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;(</span><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">-fsSL</span><span style="--0:#9ECBFF;--1:#032F62"> https://get.hy2.sh/)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">Checking</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">for</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">installed</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">version</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">...</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">v2.6.0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">Checking</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">for</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">latest</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">version</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">...</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">v2.6.0</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">Install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/hysteria/config.yaml</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">...</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">exists</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">Creating</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">user</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">...</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/dev/fd/63:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">line</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">1021:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">useradd:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">command</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">not</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">found</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ bash <(curl -fsSL https://get.hy2.sh/)Checking for installed version ... v2.6.0Checking for latest version ... v2.6.0Install /etc/hysteria/config.yaml ... existsCreating user hysteria ... /dev/fd/63: line 1021: useradd: command not found"><div></div></button></div></figure></div>
<p>　　则是系统的 PATH 环境出现问题，可以执行 <code>export PATH=$PATH:/usr/sbin</code>​ 暂时缓解，如果希望永久解决，可以将 /usr/sbin 添加到 PATH 中，在系统的 shell 配置文件（例如 ~/.bashrc 或 ~/.profile）中加入如下行：</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">export</span><span style="--0:#E1E4E8;--1:#24292E"> PATH</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">$PATH:/usr/sbin</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 然后执行以下命令来使更改生效：</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#79B8FF;--1:#005CC5">source</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">~/.bashrc</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="export PATH=$PATH:/usr/sbinsource ~/.bashrc"><div></div></button></div></figure></div>
<p>　　<strong>若域名没有 SSL 证书</strong>，则可生成自签证书（但不推荐，相当于你没有任何验证，容易被中间人攻击）。或者购买域名（namesilo 域名购买 和 cloudflare 托管解析）。但如果经过前面的设置，就无需担心，已经拥有了正规的 SSL 证书。</p>
<p>　　自签证书申请（不建议使用）</p>
<p>　　注：需要切换到 root 用户</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">su</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">openssl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">req</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-x509</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-nodes</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-newkey</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">ec:&#x3C;(</span><span style="--0:#B392F0;--1:#6F42C1">openssl</span><span style="--0:#9ECBFF;--1:#032F62"> ecparam </span><span style="--0:#79B8FF;--1:#005CC5">-name</span><span style="--0:#9ECBFF;--1:#032F62"> prime256v1)</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-keyout</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/hysteria/server.key</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-out</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/hysteria/server.crt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-subj</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"/CN=bing.com"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-days</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">36500</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">chown</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/hysteria/server.key</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">chown</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/hysteria/server.crt</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="suopenssl req -x509 -nodes -newkey ec:<(openssl ecparam -name prime256v1) -keyout /etc/hysteria/server.key -out /etc/hysteria/server.crt -subj &#x22;/CN=bing.com&#x22; -days 36500 &#x26;&#x26; sudo chown hysteria /etc/hysteria/server.key &#x26;&#x26; sudo chown hysteria /etc/hysteria/server.crt"><div></div></button></div></figure></div>
<h4 id="非面板搭建的配置">非面板搭建的配置</h4>
<p>　　如果不使用面板搭建，则需要手动设置配置文件。</p>
<h5 id="服务器配置文件">服务器配置文件</h5>
<p>　　hysteria2 支持 acme 通过 dns 方式申请证书，同样需要 <code>cloudflare_api_token</code>​，但为了方便续签和其他服务使用证书，不采用这种方式。当然，即便你采用这种方式，也不会产生任何冲突和影响。</p>
<p>　　自行修改下面的配置中用户密码、trafficStats 端口/密码。</p>
<p>　　简单解释这个配置的含义：</p>
<ol>
<li>监听 8443 端口，该端口是建立 hysteria2 服务的基础。可以修改，但需要同时允许防火墙通过端口、修改客户端配置。</li>
<li>tls 认证，配置自有域名的证书，以防止安全攻击。可以使用自签证书，但理论上并不安全，虽然大多数的小白教程都直接使用。如果完成本文前面的证书申请步骤，则这一步填入已有的证书即可。</li>
<li>auth，权限验证，验证通过，才能够正常提供服务。支持多用户认证，每个用户使用 用户名+密码 的方式进行验证，适合小规模多用户使用。<strong>需要注意：用户名不能含有大写字母。使用大写字母会连不上，目前已经确认这是一个 bug，后续版本会修复。Hysteria2 版本为 v2.6.0。</strong></li>
<li>masquerade，伪装，服务器像普通网站服务器一样真的响应 HTTP 请求，假装自己就是一个正常的网页服务器。</li>
<li>trafficStats，流量统计接口</li>
<li>bandwidth，带宽设置，不宜设置过大，造成流量浪费。</li>
</ol>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">cat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">&#x3C;&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">EOF</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/hysteria/config.yaml</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">listen: :8443 #监听端口</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#使用 acme 证书，如果用cloudflare解析dns，并开启代理，则不需要申请，只填写域名即可</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#acme:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#  domains:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#    - a.com #你的域名，需要先解析到服务器ip</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#  email: test@sharklasers.com</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#使用 acme 申请 CA 证书</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#acme:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#  domains:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">12</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#    - "*.hyperdns.com"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">13</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#  email: your_email_address</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">14</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#  type: dns</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">15</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#  dns:</span></div></div><details class="ec-section"><summary><div class="ec-line"><div class="gutter"><div class="ln"></div></div><div class="code"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 16 16" width="16" height="16"><path d="m8.177.677 2.896 2.896a.25.25 0 0 1-.177.427H8.75v1.25a.75.75 0 0 1-1.5 0V4H5.104a.25.25 0 0 1-.177-.427L7.823.677a.25.25 0 0 1 .354 0ZM7.25 10.75a.75.75 0 0 1 1.5 0V12h2.146a.25.25 0 0 1 .177.427l-2.896 2.896a.25.25 0 0 1-.354 0l-2.896-2.896A.25.25 0 0 1 5.104 12H7.25v-1.25Zm-5-2a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM6 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 6 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM12 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 12 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5Z"></path></svg>38 collapsed lines</div></div></summary><div class="ec-line"><div class="gutter"><div class="ln">16</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#    name: cloudflare</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">17</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#    config:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">18</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#      cloudflare_api_token: your_api_token</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">19</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">20</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#使用自签证书 或者已有 ca 证书</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">21</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#ca 证书</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">22</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">tls:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">23</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">cert: /home/username/fullchain.cer</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">24</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">key: /home/username/hyperdns.com.key</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">25</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#使用自签证书</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">26</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#tls:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">27</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#  cert: /etc/hysteria/server.crt</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">28</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">#  key: /etc/hysteria/server.key</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">29</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">30</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">auth:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">31</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62"># 设置多用户</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">32</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">type: userpass</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">33</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">userpass:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">34</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">usr1: 8374393j4d</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">35</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">usr2: t2rt9shd92</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">36</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">37</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">masquerade:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">38</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">type: proxy</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">39</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">proxy:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">40</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">url: https://bing.com #伪装网址</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">41</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">    </span></span><span style="--0:#9ECBFF;--1:#032F62">rewriteHost: true</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">42</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">listenHTTP: :80</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">43</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">listenHTTPS: :8443</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">44</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">45</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">trafficStats:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">46</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">listen: :22222</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">47</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">secret: trafficStats_passwd</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">48</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">49</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">bandwidth:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">50</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">up: 20 mbps</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">51</div></div><div class="code"><span class="indent"><span style="--0:#9ECBFF;--1:#032F62">  </span></span><span style="--0:#9ECBFF;--1:#032F62">down: 50 mbps</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">52</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">53</div></div><div class="code"><span style="--0:#9ECBFF;--1:#032F62">EOF</span></div></div></details></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="cat << EOF > /etc/hysteria/config.yamllisten: :8443 #监听端口tls:  cert: /home/username/fullchain.cer  key: /home/username/hyperdns.com.keyauth:  type: userpass  userpass:    usr1: 8374393j4d    usr2: t2rt9shd92masquerade:  type: proxy  proxy:    url: https://bing.com #伪装网址    rewriteHost: true  listenHTTP: :80  listenHTTPS: :8443trafficStats:  listen: :22222  secret: trafficStats_passwdbandwidth:  up: 20 mbps  down: 50 mbpsEOF"><div></div></button></div></figure></div>
<p>　　最后，服务器端需要启动 hysteria2 server，并设置开机自启。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">enable</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria-server.service</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--now</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="systemctl enable hysteria-server.service --now"><div></div></button></div></figure></div>
<p>　　并运行命令：<code>systemctl status hysteria-server.service</code>​ 查看 hysteria 日志，观察是否启动成功。</p>
<p>　　如果没有启动成功，请查看具体的报错信息，并解决。可以查看 hysteria2 官网：<a href="https://v2.hysteria.network/zh/docs/advanced/Troubleshooting/">故障排除</a>。</p>
<h5 id="端口跳跃">端口跳跃</h5>
<p>　　参考：<a href="https://v2.hysteria.network/zh/docs/advanced/Port-Hopping/#__tabbed_1_1">hysteria2 端口跳跃</a>、<a href="https://wiki.metacubex.one/config/proxies/hysteria2/">meta hysteria2配置</a></p>
<p>　　运营商可能会阻断或限速 UDP 连接。表现为突然无法使用，或者网速慢，但几分钟（十几分钟）后又恢复。不过，这些限制往往仅限单个端口。端口跳跃可用作此情况的解决方法。</p>
<p>　　Hysteria 服务端并不能同时监听多个端口，因此不能在服务器端使用上面的格式作为监听地址。<strong>建议配合 iptables 或 nftables 的 DNAT 将端口转发到服务器的监听端口。</strong></p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># IPv4</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">iptables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-A</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">PREROUTING</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">eth0</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">udp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--dport</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">20000:50000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-j</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">REDIRECT</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--to-ports</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">443</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># IPv6</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">ip6tables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-A</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">PREROUTING</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">eth0</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">udp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--dport</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">20000:50000</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-j</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">REDIRECT</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--to-ports</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">443</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="iptables -t nat -A PREROUTING -i eth0 -p udp --dport 20000:50000 -j REDIRECT --to-ports 443ip6tables -t nat -A PREROUTING -i eth0 -p udp --dport 20000:50000 -j REDIRECT --to-ports 443"><div></div></button></div></figure></div>
<p>　　在这个示例中，服务器监听 443 端口，但客户端可以通过 20000-50000 范围内的任何端口连接。</p>
<p>　　对于本示例来说，没有放行这么多端口，只放行部分（端口号需要在 1000-65535），供参考：</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">allow</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">50220:50959/udp</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">allow</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">60133:60968/udp</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">iptables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-A</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">PREROUTING</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">eth0</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">udp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--dport</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">50220:50959</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-j</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">REDIRECT</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--to-ports</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">8443</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">iptables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-A</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">PREROUTING</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">eth0</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">udp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--dport</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">60133:60968</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-j</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">REDIRECT</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--to-ports</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">8443</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">ip6tables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-A</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">PREROUTING</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">eth0</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">udp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--dport</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">50220:50959</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-j</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">REDIRECT</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--to-ports</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">8443</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">ip6tables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-A</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">PREROUTING</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-i</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">eth0</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-p</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">udp</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--dport</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">60133:60968</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-j</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">REDIRECT</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--to-ports</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">8443</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="ufw allow 50220:50959/udpufw allow 60133:60968/udpiptables -t nat -A PREROUTING -i eth0 -p udp --dport 50220:50959 -j REDIRECT --to-ports 8443iptables -t nat -A PREROUTING -i eth0 -p udp --dport 60133:60968 -j REDIRECT --to-ports 8443ip6tables -t nat -A PREROUTING -i eth0 -p udp --dport 50220:50959 -j REDIRECT --to-ports 8443ip6tables -t nat -A PREROUTING -i eth0 -p udp --dport 60133:60968 -j REDIRECT --to-ports 8443"><div></div></button></div></figure></div>
<p>　　如果添加出错，需要删除规则，则可以参考：</p>
<h6 id="删除-ufw-规则">删除 ufw 规则</h6>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">status</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">numbered</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># 查看规则的编号</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">ufw</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">delete</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">3</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># 删除想删除的规则的编号</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="ufw status numbered # 查看规则的编号ufw delete 3 # 删除想删除的规则的编号"><div></div></button></div></figure></div>
<h6 id="删除改-iptables">删除改 iptables</h6>
<p>　　列出当前的规则并找到规则的编号。使用以下命令列出规则：</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">iptables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-L</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-v</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-n</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--line-numbers</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">iptables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-L</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-v</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-n</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># 查看添加的 nat 规则</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo iptables -L -v -n --line-numberssudo iptables -L -v -n -t nat # 查看添加的 nat 规则"><div></div></button></div></figure></div>
<p>　　这会输出规则列表，并在每个规则前面显示一个编号。假设你要删除编号为 2 的规则，可以执行：</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">iptables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-D</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;链名></span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;规则编号></span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo iptables -D <链名> <规则编号>"><div></div></button></div></figure></div>
<p>　　例如，要删除 nat 表中的 PREROUTING 链上的第 2 条规则：</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">iptables</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nat</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-D</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">PREROUTING</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo iptables -t nat -D PREROUTING 2"><div></div></button></div></figure></div>
<h5 id="使用端配置">使用端配置</h5>
<p>　　clash.meta 为例，在配置文件中按照如下方式填写，yaml 格式。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">proxies:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">-</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">name:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"🇺🇸 Hysteria"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># Hysteria2 不支持套用 CDN</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">server:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">your_ip</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">port:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">8443</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">ports:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">50220-50959/60133-60968</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">type</span><span style="--0:#9ECBFF;--1:#032F62">:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">password:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">usr1:8374393j4d</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># 多用户配置 用户名:密码</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">up:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">20</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">down:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">50</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">sni:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">www.hyperdns.com</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">skip-cert-verify:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">false</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="proxies:  - name: &#x22;🇺🇸 Hysteria&#x22; # Hysteria2 不支持套用 CDN    server: your_ip    port: 8443    ports: 50220-50959/60133-60968    type: hysteria2    password: usr1:8374393j4d # 多用户配置 用户名:密码    up: 20    down: 50    sni: www.hyperdns.com    skip-cert-verify: false"><div></div></button></div></figure></div>
<p>　　将上述节点信息，添加到已有的 clash 配置文件中，就可以看到节点，如果检测不通，则说明信息填写错误，请仔细检查，并确认 hysteria 服务器端成功启动。节点信息配置出错，或者与服务端不匹配，则无法连通。</p>
<p>　　填写参考：</p>
<p>　　server 填写服务器 ip 或者没有开启代理的域名。 hysteria 不支持cdn，开启代理会导致无法正常使用。如果使用域名，有可能会发生不稳定的情况，这时改回 ip 即可。</p>
<p>　　port 监听端口要和服务器一致。</p>
<p>　　ports 端口跳跃端口也要和服务器上开放的端口一致，保证服务器防火墙放行对应端口，并设置端口转发到监听端口。</p>
<p>　　密码 password 要正确，多用户需要注意格式要求，用户名和密码中间必须要有 <code>:</code>​ 但不能有空格。</p>
<p>　　sni 认证网址也要正确，需要和证书提供的一致。但这仅限于 tls 认证，只要该域名是证书中包含的域名即可。</p>
<h5 id="常用指令">常用指令</h5>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#启动Hysteria2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">start</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria-server.service</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#重启Hysteria2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">restart</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria-server.service</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#查看Hysteria2状态</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">status</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria-server.service</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#停止Hysteria2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">stop</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria-server.service</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#设置开机自启</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">enable</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria-server.service</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#查看日志</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">12</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">journalctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-u</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria-server.service</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="systemctl start hysteria-server.servicesystemctl restart hysteria-server.servicesystemctl status hysteria-server.servicesystemctl stop hysteria-server.servicesystemctl enable hysteria-server.servicejournalctl -u hysteria-server.service"><div></div></button></div></figure></div>
<h5 id="流量统计-api">流量统计 API</h5>
<p>　　在服务端配置 <code>trafficStats</code>​ 后，可通过 HTTP API 查询服务器的==流量==统计信息，以及踢用户下线。</p>
<p>　　注：下述 api 都是 http，不安全。在后续使用 nginx 反代时，会更新为 https 访问方式。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-H</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">'Authorization: trafficStats_passwd'</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">http://ip_address:22222/traffic</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="curl -H &#x27;Authorization: trafficStats_passwd&#x27; http://ip_address:22222/traffic"><div></div></button></div></figure></div>
<p>　　bash 脚本</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972">#!/bin/bash</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">green</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">'\033[0;32m'</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">cyan</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">'\033[0;36m'</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">'\033[0m'</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># No Color</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 显示在线用户</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"在线用户："</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-H</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">'Authorization: trafficStats_passwd'</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">http://ip_address:22222/online</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code"><span style="--0:#79B8FF;--1:#005CC5">echo</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 函数：将字节转换为可读格式</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">bytes_to_readable</span><span style="--0:#E1E4E8;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">12</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">local</span><span style="--0:#E1E4E8;--1:#24292E"> bytes</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#FFAB70;--1:#AE4B07">$1</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">13</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> (( bytes </span><span style="--0:#F97583;--1:#BF3441">&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1024</span><span style="--0:#E1E4E8;--1:#24292E"> )); </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">14</div></div><div class="code"><span class="indent">        </span><span style="--0:#79B8FF;--1:#005CC5">printf</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"%d B"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$bytes</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">15</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">elif</span><span style="--0:#E1E4E8;--1:#24292E"> (( bytes </span><span style="--0:#F97583;--1:#BF3441">&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1024</span><span style="--0:#F97583;--1:#BF3441">**</span><span style="--0:#79B8FF;--1:#005CC5">2</span><span style="--0:#E1E4E8;--1:#24292E"> )); </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><details class="ec-section"><summary><div class="ec-line"><div class="gutter"><div class="ln"></div></div><div class="code"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 16 16" width="16" height="16"><path d="m8.177.677 2.896 2.896a.25.25 0 0 1-.177.427H8.75v1.25a.75.75 0 0 1-1.5 0V4H5.104a.25.25 0 0 1-.177-.427L7.823.677a.25.25 0 0 1 .354 0ZM7.25 10.75a.75.75 0 0 1 1.5 0V12h2.146a.25.25 0 0 1 .177.427l-2.896 2.896a.25.25 0 0 1-.354 0l-2.896-2.896A.25.25 0 0 1 5.104 12H7.25v-1.25Zm-5-2a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM6 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 6 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM12 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 12 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5Z"></path></svg>29 collapsed lines</div></div></summary><div class="ec-line"><div class="gutter"><div class="ln">16</div></div><div class="code"><span class="indent">        </span><span style="--0:#79B8FF;--1:#005CC5">printf</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"%.2f KB"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"$(</span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#9ECBFF;--1:#032F62"> "scale=2; </span><span style="--0:#E1E4E8;--1:#24292E">$bytes</span><span style="--0:#9ECBFF;--1:#032F62"> / 1024" </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#B392F0;--1:#6F42C1">bc</span><span style="--0:#9ECBFF;--1:#032F62">)"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">17</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">elif</span><span style="--0:#E1E4E8;--1:#24292E"> (( bytes </span><span style="--0:#F97583;--1:#BF3441">&#x3C;</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">1024</span><span style="--0:#F97583;--1:#BF3441">**</span><span style="--0:#79B8FF;--1:#005CC5">3</span><span style="--0:#E1E4E8;--1:#24292E"> )); </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">18</div></div><div class="code"><span class="indent">        </span><span style="--0:#79B8FF;--1:#005CC5">printf</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"%.2f MB"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"$(</span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#9ECBFF;--1:#032F62"> "scale=2; </span><span style="--0:#E1E4E8;--1:#24292E">$bytes</span><span style="--0:#9ECBFF;--1:#032F62"> / (1024^2)" </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#B392F0;--1:#6F42C1">bc</span><span style="--0:#9ECBFF;--1:#032F62">)"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">19</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">20</div></div><div class="code"><span class="indent">        </span><span style="--0:#79B8FF;--1:#005CC5">printf</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"%.2f GB"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"$(</span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#9ECBFF;--1:#032F62"> "scale=2; </span><span style="--0:#E1E4E8;--1:#24292E">$bytes</span><span style="--0:#9ECBFF;--1:#032F62"> / (1024^3)" </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#B392F0;--1:#6F42C1">bc</span><span style="--0:#9ECBFF;--1:#032F62">)"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">21</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">fi</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">22</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">23</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">24</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 设置URL和头部</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">25</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">URL</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"http://ip_address:22222/traffic"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">26</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">AUTH_HEADER</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#9ECBFF;--1:#032F62">"Authorization: trafficStats_passwd"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">27</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">28</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 发送GET请求并获取响应</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">29</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">response</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">$(</span><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-s</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-w</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"HTTPSTATUS:%{http_code}"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-H</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$AUTH_HEADER</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$URL</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">30</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">31</div></div><div class="code"><span style="--0:#99A0A6;--1:#616972"># 提取body和状态码</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">32</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">body</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">$(</span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$response</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">sed</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">'s/HTTPSTATUS\:.*//g'</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">33</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">status_code</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">$(</span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$response</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">tr</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-d</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">'\n'</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">sed</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">'s/.*HTTPSTATUS://'</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">34</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">35</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">if</span><span style="--0:#E1E4E8;--1:#24292E"> [ </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$status_code</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">-eq</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">200</span><span style="--0:#E1E4E8;--1:#24292E"> ]; </span><span style="--0:#F97583;--1:#BF3441">then</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">36</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972"># 使用 jq 解析 JSON 并遍历每个键</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">37</div></div><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$body</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">jq</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-r</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">'to_entries[] | "\(.key) \(.value.tx) \(.value.rx)"'</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">while</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">read</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-r</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">key</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">tx</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">rx</span><span style="--0:#E1E4E8;--1:#24292E">; </span><span style="--0:#F97583;--1:#BF3441">do</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">38</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">readable_tx</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">$(</span><span style="--0:#B392F0;--1:#6F42C1">bytes_to_readable</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$tx</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">39</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">        </span></span><span style="--0:#E1E4E8;--1:#24292E">readable_rx</span><span style="--0:#F97583;--1:#BF3441">=</span><span style="--0:#E1E4E8;--1:#24292E">$(</span><span style="--0:#B392F0;--1:#6F42C1">bytes_to_readable</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$rx</span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">40</div></div><div class="code"><span class="indent">        </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-e</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"</span><span style="--0:#E1E4E8;--1:#24292E">$key</span><span style="--0:#9ECBFF;--1:#032F62">: 上传 ${</span><span style="--0:#E1E4E8;--1:#24292E">green</span><span style="--0:#9ECBFF;--1:#032F62">}${</span><span style="--0:#E1E4E8;--1:#24292E">readable_tx</span><span style="--0:#9ECBFF;--1:#032F62">}${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">}, 下载${</span><span style="--0:#E1E4E8;--1:#24292E">cyan</span><span style="--0:#9ECBFF;--1:#032F62">}${</span><span style="--0:#E1E4E8;--1:#24292E">readable_rx</span><span style="--0:#9ECBFF;--1:#032F62">}${</span><span style="--0:#E1E4E8;--1:#24292E">NC</span><span style="--0:#9ECBFF;--1:#032F62">}"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">41</div></div><div class="code"><span class="indent">    </span><span style="--0:#F97583;--1:#BF3441">done</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">42</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">43</div></div><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">echo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"请求失败，状态码：</span><span style="--0:#E1E4E8;--1:#24292E">$status_code</span><span style="--0:#9ECBFF;--1:#032F62">"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">44</div></div><div class="code"><span style="--0:#F97583;--1:#BF3441">fi</span></div></div></details></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="#!/bin/bashgreen=&#x27;\033[0;32m&#x27;cyan=&#x27;\033[0;36m&#x27;NC=&#x27;\033[0m&#x27; # No Color# 显示在线用户echo &#x22;在线用户：&#x22;curl -H &#x27;Authorization: trafficStats_passwd&#x27; http://ip_address:22222/onlineecho# 函数：将字节转换为可读格式bytes_to_readable() {    local bytes=$1    if (( bytes < 1024 )); then        printf &#x22;%d B&#x22; &#x22;$bytes&#x22;    elif (( bytes < 1024**2 )); then        printf &#x22;%.2f KB&#x22; &#x22;$(echo &#x22;scale=2; $bytes / 1024&#x22; | bc)&#x22;    elif (( bytes < 1024**3 )); then        printf &#x22;%.2f MB&#x22; &#x22;$(echo &#x22;scale=2; $bytes / (1024^2)&#x22; | bc)&#x22;    else        printf &#x22;%.2f GB&#x22; &#x22;$(echo &#x22;scale=2; $bytes / (1024^3)&#x22; | bc)&#x22;    fi}# 设置URL和头部URL=&#x22;http://ip_address:22222/traffic&#x22;AUTH_HEADER=&#x22;Authorization: trafficStats_passwd&#x22;# 发送GET请求并获取响应response=$(curl -s -w &#x22;HTTPSTATUS:%{http_code}&#x22; -H &#x22;$AUTH_HEADER&#x22; &#x22;$URL&#x22;)# 提取body和状态码body=$(echo &#x22;$response&#x22; | sed -e &#x27;s/HTTPSTATUS\:.*//g&#x27;)status_code=$(echo &#x22;$response&#x22; | tr -d &#x27;\n&#x27; | sed -e &#x27;s/.*HTTPSTATUS://&#x27;)if [ &#x22;$status_code&#x22; -eq 200 ]; then    # 使用 jq 解析 JSON 并遍历每个键    echo &#x22;$body&#x22; | jq -r &#x27;to_entries[] | &#x22;\(.key) \(.value.tx) \(.value.rx)&#x22;&#x27; | while read -r key tx rx; do        readable_tx=$(bytes_to_readable &#x22;$tx&#x22;)        readable_rx=$(bytes_to_readable &#x22;$rx&#x22;)        echo -e &#x22;$key: 上传 ${green}${readable_tx}${NC}, 下载${cyan}${readable_rx}${NC}&#x22;    doneelse    echo &#x22;请求失败，状态码：$status_code&#x22;fi"><div></div></button></div></figure></div>
<h3 id="搭建缓解-tit-特征的-vlessvisiontls">搭建缓解 TIT 特征的 vless+vision+tls</h3>
<p>　　TIT 特征 TLS in TLS 是一种 TIS 传输 TLS 的特征，可能在某些地区能够被精确的识别和封禁。目前可以通过一些搭建方式来缓解。比如 naive 和 vision 通过字节填充来缓解 TIT。</p>
<p>　　参考：<a href="https://www.youtube.com/watch?v=SpxTFes1B8U&#x26;t=923s">搭建 VISION 节点</a>、<a href="https://www.youtube.com/watch?v=Z_URro3bZqM&#x26;t=660s">TIT 问题及解决方式</a></p>
<p>　　使用 x-ui 面板搭建节点，x-ui 是一个前端项目，负责通过 UI 界面配置节点参数，最终使用 xray 来搭建节点。</p>
<h4 id="安装-x-ui-面板">安装 x-ui 面板</h4>
<p>　　x-ui 虽然提供了 docker 镜像，但是没有更新，且不好使用。还是直接安装比较合适。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">bash</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">&#x3C;(</span><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#9ECBFF;--1:#032F62"> </span><span style="--0:#79B8FF;--1:#005CC5">-Ls</span><span style="--0:#9ECBFF;--1:#032F62"> https://raw.githubusercontent.com/FranzKafkaYu/x-ui/956bf85bbac978d56c0e319c5fac2d6db7df9564/install.sh)</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">0.3.4.4</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="bash <(curl -Ls https://raw.githubusercontent.com/FranzKafkaYu/x-ui/956bf85bbac978d56c0e319c5fac2d6db7df9564/install.sh) 0.3.4.4"><div></div></button></div></figure></div>
<p>　　安装时，建议修改端口和账号用户与密码。</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20250108130119-d08wsnw.png" data-alt="image">​</p>
<p>　　需要防火墙放行自己设定的端口，假设设置的是 11080 端口。</p>
<p>　　安装后输入命令 <code>x-ui</code>​ 可以查看使用方式。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">root@LA:~#</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x-ui</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">x-ui</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">面板管理脚本</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">0.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">退出脚本</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">————————————————</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">1.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">安装</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x-ui</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">2.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">更新</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x-ui</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">3.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">卸载</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x-ui</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">————————————————</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">4.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">重置用户名密码</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">5.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">重置面板设置</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">12</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">6.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">设置面板端口</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">13</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">7.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">查看当前面板信息</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">14</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">————————————————</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">15</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">8.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">启动</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x-ui</span></div></div><details class="ec-section"><summary><div class="ec-line"><div class="gutter"><div class="ln"></div></div><div class="code"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 16 16" width="16" height="16"><path d="m8.177.677 2.896 2.896a.25.25 0 0 1-.177.427H8.75v1.25a.75.75 0 0 1-1.5 0V4H5.104a.25.25 0 0 1-.177-.427L7.823.677a.25.25 0 0 1 .354 0ZM7.25 10.75a.75.75 0 0 1 1.5 0V12h2.146a.25.25 0 0 1 .177.427l-2.896 2.896a.25.25 0 0 1-.354 0l-2.896-2.896A.25.25 0 0 1 5.104 12H7.25v-1.25Zm-5-2a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM6 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 6 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM12 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 12 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5Z"></path></svg>17 collapsed lines</div></div></summary><div class="ec-line"><div class="gutter"><div class="ln">16</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">9.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">停止</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x-ui</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">17</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">10.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">重启</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x-ui</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">18</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">11.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">查看</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x-ui</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">状态</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">19</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">12.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">查看</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x-ui</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">日志</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">20</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">————————————————</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">21</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">13.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">设置</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x-ui</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">开机自启</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">22</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">14.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">取消</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">x-ui</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">开机自启</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">23</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">————————————————</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">24</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">15.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">一键安装</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">bbr</span><span style="--0:#E1E4E8;--1:#24292E"> (最新内核)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">25</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">16.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">一键申请SSL证书</span><span style="--0:#E1E4E8;--1:#24292E">(</span><span style="--0:#B392F0;--1:#6F42C1">acme申请</span><span style="--0:#E1E4E8;--1:#24292E">)</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">26</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">17.</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">配置x-ui定时任务</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">27</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">28</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">面板状态:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">已运行</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">29</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">是否开机自启:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">是</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">30</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">xray</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">状态:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">运行</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">31</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">32</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">请输入选择</span><span style="--0:#E1E4E8;--1:#24292E"> [0-17],查看面板登录信息请输入数字7:0</span></div></div></details></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="root@LA:~# x-ui  x-ui 面板管理脚本  0. 退出脚本————————————————  1. 安装 x-ui  2. 更新 x-ui  3. 卸载 x-ui————————————————  4. 重置用户名密码  5. 重置面板设置  6. 设置面板端口  7. 查看当前面板信息————————————————  8. 启动 x-ui  9. 停止 x-ui  10. 重启 x-ui  11. 查看 x-ui 状态  12. 查看 x-ui 日志————————————————  13. 设置 x-ui 开机自启  14. 取消 x-ui 开机自启————————————————  15. 一键安装 bbr (最新内核)  16. 一键申请SSL证书(acme申请)  17. 配置x-ui定时任务面板状态: 已运行是否开机自启: 是xray 状态: 运行请输入选择 [0-17],查看面板登录信息请输入数字7:0"><div></div></button></div></figure></div>
<h4 id="x-ui-面板">x-ui 面板</h4>
<p>　　安装成功后，需要登陆面板进行操作。鉴于目前对 http 访问的安全风险很重视，在初次没有配置好 https 时，需要先用 ssh 隧道进行访问。</p>
<p>　　在本机上输入下列命令，让本机的 11080 端口和服务器的 11080 端口建立 ssh 隧道。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">ssh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-L</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">11080:localhost:11080</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">user@serverip</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="ssh -L 11080:localhost:11080 user@serverip"><div></div></button></div></figure></div>
<p>　　在浏览器中输入 <code>http://localhost:port</code>​ 登陆 x-ui 面板，第一次登陆以后，点击面板设置，会自动更改根路径，后续登陆需要输入 <code>http://localhost:port/新根路径</code>​ 才能正常登陆。其中 port 在安装时由自己设置，本例子中为 11080。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">http://localhost:port/5I1Q/xui/</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="http://localhost:port/5I1Q/xui/"><div></div></button></div></figure></div>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20250108161043-tvwy4b1.png" data-alt="image">​</p>
<p>　　但这种方式不要长期使用，当我们登入面板后，就应该立即去设置中，将 http 明文访问，升级为 https。</p>
<p>　　此处，填写已经申请到的 fullchain 证书，和密钥。保存后重启面板即可通过下面的网址访问</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">https://ip:port/5I1Q</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="https://ip:port/5I1Q"><div></div></button></div></figure></div>
<p>　　但这样访问，浏览器会提示不安全，因为 ip 并不符合证书中所认证的域名。所以，还需要在 cloudflare 中为 xui 面板单独设置一个三级域名单独用于访问 xui 面板，并且需要和后续的 nginx 分流配合起来，让访问 xui 域名的流量由 443 正确的分到 xui 端口。</p>
<p>　　否则就需要在 cloudflare 中配置 Origin Rules 将 cloudflare 前端代理的 443 端口流量自动的分流到服务器的对应端口，服务器也因此要开放 xui 端口，有暴露服务的风险。</p>
<h4 id="x-ui-搭建配置">x-ui 搭建配置</h4>
<p>　　在面板添加节点。</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20250108162214-lbnildp.png" data-alt="image">​</p>
<p>　　注：flow 在打开 4 和 5 后才会显示。</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20250108163435-t0ao2u0.png" data-alt="image">​</p>
<p>　　还<strong>需要防火墙放行 xray 的端口</strong>。</p>
<p>　　其中<strong>域名需要解析到服务器的ip地址</strong>，<strong>且 cloudflare 解析时，不能打开代理</strong>。</p>
<h4 id="使用端配置-1">使用端配置</h4>
<p>　　直接复制面板中提供的链接可以导入到小火箭，但是不能导入到 clash，clash 需要手动配置，或者用 sub-store 转换。这里还没有搭建 sub-store，则手动填写。</p>
<p>　　clash 端</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">proxies:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">-</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">name:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">"🇺🇸 vless"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span class="indent">    </span><span style="--0:#79B8FF;--1:#005CC5">type</span><span style="--0:#9ECBFF;--1:#032F62">:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">vless</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">server:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hvl.hyperdns.com</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># 解析到真实ip，不套用 CDN</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">port:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">58505</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">udp:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">true</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">uuid:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">c19119d6-796d-4c4b-add6-8392jeusisk</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">flow:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">xtls-rprx-vision</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">packet-encoding:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">xudp</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">tls:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">true</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">servername:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hvl.hyperdns.com</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">12</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">alpn:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">13</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">-</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">h2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">14</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">-</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">http/1.1</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">15</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">client-fingerprint:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">chrome</span></div></div><details class="ec-section"><summary><div class="ec-line" style="--ecIndent:4ch"><div class="gutter"><div class="ln"></div></div><div class="code"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 16 16" width="16" height="16"><path d="m8.177.677 2.896 2.896a.25.25 0 0 1-.177.427H8.75v1.25a.75.75 0 0 1-1.5 0V4H5.104a.25.25 0 0 1-.177-.427L7.823.677a.25.25 0 0 1 .354 0ZM7.25 10.75a.75.75 0 0 1 1.5 0V12h2.146a.25.25 0 0 1 .177.427l-2.896 2.896a.25.25 0 0 1-.354 0l-2.896-2.896A.25.25 0 0 1 5.104 12H7.25v-1.25Zm-5-2a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM6 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 6 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM12 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 12 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5Z"></path></svg>4 collapsed lines</div></div></summary><div class="ec-line"><div class="gutter"><div class="ln">16</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">skip-cert-verify:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">false</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">17</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">network:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">tcp</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">18</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">smux:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">19</div></div><div class="code"><span class="indent">      </span><span style="--0:#B392F0;--1:#6F42C1">enabled:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">false</span></div></div></details></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="proxies:  - name: &#x22;🇺🇸 vless&#x22;    type: vless    server: hvl.hyperdns.com # 解析到真实ip，不套用 CDN    port: 58505    udp: true    uuid: c19119d6-796d-4c4b-add6-8392jeusisk    flow: xtls-rprx-vision    packet-encoding: xudp    tls: true    servername: hvl.hyperdns.com    alpn:      - h2      - http/1.1    client-fingerprint: chrome    skip-cert-verify: false    network: tcp    smux:      enabled: false"><div></div></button></div></figure></div>
<p>　　上述节点导入后就可以正常访问了。</p>
<h2 id="订阅服务搭建">订阅服务搭建</h2>
<p>　　参考：<a href="https://surge.tel/08/2930/">通过VPS架设Sub-Store(新版)</a>、<a href="https://wiki.repcz.link/substore/install/#_1">SubStore 部署</a></p>
<p>　　Sub-Store 项目分为前后端，前后端是分离的，部署在 VPS 上则需要前后端都部署，并且需要在前端访问之前套一个 Nginx，否则传输的都是 http 流量，不安全。部署后，可以在任意前端设置后端 api，即可使用。因此，在 mihomo-party 中，可以输入后端 api，以支持节点分享。</p>
<h3 id="安装组件">安装组件</h3>
<p>　　同样先进入 <code>su</code>​。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">update</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-y</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">unzip</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">wget</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">git</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-y</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="apt update -y &#x26;&#x26; apt install unzip curl wget git -y"><div></div></button></div></figure></div>
<h4 id="安装-fnm---node-版本管理器">安装 FNM - Node 版本管理器</h4>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">$</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-fsSL</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">https://fnm.vercel.app/install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">bash</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#79B8FF;--1:#005CC5">...</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">In</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">order</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">to</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">apply</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">the</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">changes,</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">open</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">a</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">new</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">terminal</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">or</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">run</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">the</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">following</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">command:</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span class="indent">  </span><span style="--0:#79B8FF;--1:#005CC5">source</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/root/.bashrc</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ curl -fsSL https://fnm.vercel.app/install | bash...In order to apply the changes, open a new terminal or run the following command:  source /root/.bashrc"><div></div></button></div></figure></div>
<p>　　按照回显的图示，运行命令保存生效</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#79B8FF;--1:#005CC5">source</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/root/.bashrc</span><span style="--0:#E1E4E8;--1:#24292E">  </span><span style="--0:#99A0A6;--1:#616972">#请按照你的回显提示命令进行输入</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="source /root/.bashrc  #请按照你的回显提示命令进行输入"><div></div></button></div></figure></div>
<h4 id="fnm-安装-node">FNM 安装 Node</h4>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">fnm</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">v20.18.0</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="fnm install v20.18.0"><div></div></button></div></figure></div>
<p>　　可以安装其他版本，但是后续服务配置文件需要同步修改版本。</p>
<h4 id="安装-pnpm-软件包管理器">安装 PNPM 软件包管理器</h4>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">curl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-fsSL</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">https://get.pnpm.io/install.sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#F97583;--1:#BF3441">|</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#B392F0;--1:#6F42C1">sh</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">-</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="curl -fsSL https://get.pnpm.io/install.sh | sh -"><div></div></button></div></figure></div>
<p>　　按照回显的图示，运行命令</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#79B8FF;--1:#005CC5">source</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/root/.bashrc</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="source /root/.bashrc"><div></div></button></div></figure></div>
<h3 id="安装-sub-store">安装 Sub-Store</h3>
<h4 id="创建文件夹并拉取项目">创建文件夹并拉取项目</h4>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">mkdir -p /root/sub-store  #在 root 目录下面创建 sub-store 文件夹</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">cd /root/sub-store   #进入 sub-store 文件夹</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="mkdir -p /root/sub-store  #在 root 目录下面创建 sub-store 文件夹cd /root/sub-store   #进入 sub-store 文件夹"><div></div></button></div></figure></div>
<h4 id="拉取项目并解压">拉取项目并解压</h4>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e"># 拉取后端项目</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">curl -fsSL https://github.com/sub-store-org/Sub-Store/releases/latest/download/sub-store.bundle.js -o sub-store.bundle.js</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e"># 拉取前端项目</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">curl -fsSL https://github.com/sub-store-org/Sub-Store-Front-End/releases/latest/download/dist.zip -o dist.zip</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="# 拉取后端项目curl -fsSL https://github.com/sub-store-org/Sub-Store/releases/latest/download/sub-store.bundle.js -o sub-store.bundle.js# 拉取前端项目curl -fsSL https://github.com/sub-store-org/Sub-Store-Front-End/releases/latest/download/dist.zip -o dist.zip"><div></div></button></div></figure></div>
<p>　　解压前端文件，并改名为 frontend，而后删除源压缩文件</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">unzip</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">dist.zip</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">mv</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">dist</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">frontend</span><span style="--0:#E1E4E8;--1:#24292E"> &#x26;&#x26; </span><span style="--0:#B392F0;--1:#6F42C1">rm</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">dist.zip</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="unzip dist.zip &#x26;&#x26; mv dist frontend &#x26;&#x26; rm dist.zip"><div></div></button></div></figure></div>
<h4 id="创建系统服务">创建系统服务</h4>
<p>　　pm2 的启动方式会有 BUG，所以我们采用服务进程的方式来启动</p>
<p>　　进入 VPS 目录 <code>/etc/systemd/system/</code>​，在里面创建一个文件 <code>sub-store.service</code>​，</p>
<p>　　​<code>vim /etc/systemd/system/sub-store.service</code>​</p>
<p>　　写入以下服务信息</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">[Unit]</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Description=Sub-Store</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">After=network-online.target</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Wants=network-online.target systemd-networkd-wait-online.service</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">[Service]</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">LimitNOFILE=32767</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Type=simple</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Environment="SUB_STORE_FRONTEND_BACKEND_PATH=/2cXaAxRGfddmGz2yx1wA"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Environment="SUB_STORE_BACKEND_CRON=0 0 * * *"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Environment="SUB_STORE_FRONTEND_PATH=/root/sub-store/frontend"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">12</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Environment="SUB_STORE_FRONTEND_HOST=0.0.0.0"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">13</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Environment="SUB_STORE_FRONTEND_PORT=3001"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">14</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Environment="SUB_STORE_DATA_BASE_PATH=/root/sub-store"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">15</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Environment="SUB_STORE_BACKEND_API_HOST=127.0.0.1"</span></div></div><details class="ec-section"><summary><div class="ec-line"><div class="gutter"><div class="ln"></div></div><div class="code"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 16 16" width="16" height="16"><path d="m8.177.677 2.896 2.896a.25.25 0 0 1-.177.427H8.75v1.25a.75.75 0 0 1-1.5 0V4H5.104a.25.25 0 0 1-.177-.427L7.823.677a.25.25 0 0 1 .354 0ZM7.25 10.75a.75.75 0 0 1 1.5 0V12h2.146a.25.25 0 0 1 .177.427l-2.896 2.896a.25.25 0 0 1-.354 0l-2.896-2.896A.25.25 0 0 1 5.104 12H7.25v-1.25Zm-5-2a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM6 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 6 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM12 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 12 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5Z"></path></svg>12 collapsed lines</div></div></summary><div class="ec-line"><div class="gutter"><div class="ln">16</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Environment="SUB_STORE_BACKEND_API_PORT=3000"</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">17</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">ExecStart=/root/.local/share/fnm/fnm exec --using v20.18.0 node /root/sub-store/sub-store.bundle.js</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">18</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">User=root</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">19</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Group=root</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">20</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">Restart=on-failure</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">21</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">RestartSec=5s</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">22</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">ExecStartPre=/bin/sh -c ulimit -n 51200</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">23</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">StandardOutput=journal</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">24</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">StandardError=journal</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">25</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">26</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">[Install]</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">27</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">WantedBy=multi-user.target</span></div></div></details></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="[Unit]Description=Sub-StoreAfter=network-online.targetWants=network-online.target systemd-networkd-wait-online.service[Service]LimitNOFILE=32767Type=simpleEnvironment=&#x22;SUB_STORE_FRONTEND_BACKEND_PATH=/2cXaAxRGfddmGz2yx1wA&#x22;Environment=&#x22;SUB_STORE_BACKEND_CRON=0 0 * * *&#x22;Environment=&#x22;SUB_STORE_FRONTEND_PATH=/root/sub-store/frontend&#x22;Environment=&#x22;SUB_STORE_FRONTEND_HOST=0.0.0.0&#x22;Environment=&#x22;SUB_STORE_FRONTEND_PORT=3001&#x22;Environment=&#x22;SUB_STORE_DATA_BASE_PATH=/root/sub-store&#x22;Environment=&#x22;SUB_STORE_BACKEND_API_HOST=127.0.0.1&#x22;Environment=&#x22;SUB_STORE_BACKEND_API_PORT=3000&#x22;ExecStart=/root/.local/share/fnm/fnm exec --using v20.18.0 node /root/sub-store/sub-store.bundle.jsUser=rootGroup=rootRestart=on-failureRestartSec=5sExecStartPre=/bin/sh -c ulimit -n 51200StandardOutput=journalStandardError=journal[Install]WantedBy=multi-user.target"><div></div></button></div></figure></div>
<p>　　上面服务代码中的 <code>2cXaAxRGfddmGz2yx1wA</code>​ 为API请求密钥，请自行修改，推荐自动生成地址：<a href="https://1password.com/zh-cn/password-generator">点击访问</a></p>
<p>　　启动服务，并设置开机自启。如果前面 fnm 安装 nodo 时，不是版本 v20.18.0，这里需要同步修改，否则执行不成功。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">enable</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sub-store.service</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">--now</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="systemctl enable sub-store.service --now"><div></div></button></div></figure></div>
<p>　　后端服务相关命令</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">systemctl start sub-store.service     #启动服务</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">systemctl enable sub-store.service    #设置为开机自启</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">systemctl status sub-store.service    #查看服务状态</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">systemctl stop sub-store.service      #停止服务</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">systemctl restart sub-store.service   #重启服务</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="systemctl start sub-store.service     #启动服务systemctl enable sub-store.service    #设置为开机自启systemctl status sub-store.service    #查看服务状态systemctl stop sub-store.service      #停止服务systemctl restart sub-store.service   #重启服务"><div></div></button></div></figure></div>
<p>　　正常情况下，运行服务状态，应该类似下图：（ <code>active:running</code>​ ）</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20241219143703-unox048.png" data-alt="image">​</p>
<h2 id="nginx">Nginx</h2>
<p>　　前面搭建面板、订阅服务时，都需要在访问时，加上对应的端口号，如果暴露在公网，有安全风险。可以通过搭建 Nginx 服务，对外只暴露 443 80 端口，将 443 加密流量在 Nginx 内部分流到不同的本地端口，本地端口不需要暴露。就解决了这个问题。</p>
<h3 id="安装-nginx">安装 Nginx</h3>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">apt</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">install</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">libnginx-mod-stream</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nginx</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-y</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo apt install libnginx-mod-stream nginx -y"><div></div></button></div></figure></div>
<h3 id="配置分流">配置分流</h3>
<p>　　在我的主机上，同时存在 <code>x-ui面板</code>​、<code>hysteria2</code>​，因此，希望 <code>sub-store</code>​ 可以和其他两个服务共存。且 <code>hysteria2</code>​ 伪装需要监听 80 443 端口，普通的 https 网络访问，也需要直接访问 443 端口。</p>
<p>　　在拥有一个有 ssl 认证的域名，一台可用服务器时，有两种解决方式：</p>
<ol>
<li>
<p>通过 Cloudfalre 设置 Origin Rules，根据不同的 访问域名，将服务转发到不同的端口。例如：<code>hysteria2</code>​ 仍然监听 80，443端口，<code>x-ui面板</code>​ 设置访问端口 81，<code>sub-store</code>​设置访问端口 82。然后 Cloudfalre 中将访问 sub.name.com 的 https 流量转发到服务器的 82 端口，访问 xui.name.com 的 https 流量转发到服务器的 81 端口，普通流量不管，自动转发到服务器的 80，443。但由于 sub-store 不支持 https 流量，所以还是需要设置 nginx 服务器，将 https 流量解析并代理成 http 流量到 sub-store 端口。</p>
</li>
<li>
<p>设置 nginx 反代服务，开放 443，80，8443端口。xui、sub-store 的网络访问都走 443，hysteria 监听 80 和 8443，hysteria 代理端口也为 8443。ngnix 将流量从 443 分流到 xui、sub-store、hysteria各自的端口上。当通过 https 协议访问 443 时，xui、sub-store分流到各自端口，其余流量全部分流到 8443，这部分流量被重定向到伪装站，而符合 hysteria 代理流量会直接访问 8443，不走 nginx 分流。</p>
<p>示意图如下：</p>
<p>​<img src="/spinner.gif" alt="default" data-src="/images/%E5%B9%B4%E8%BD%BB%E4%BA%BA%E7%9A%84%E7%AC%AC%E4%B8%80%E5%8F%B0%20VPS%20%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/Nginx-Rules-20241224161539-5iq1no8.png" data-alt="Nginx-Rules">​</p>
</li>
</ol>
<p>　　因为一定需要 nginx 作反代，所以，采用第二种方式。</p>
<h3 id="配置-nginx-stream-分流和-nginx-server">配置 nginx stream 分流和 nginx server</h3>
<p>　　在 <code>/etc/nginx/nginx.conf</code>​ 中的 http 块外部分，也就是顶层配置下，加入 <code>include /etc/nginx/vps.conf;</code>​，并删除 <code>/etc/nginx/site-enabled</code>​ 下的基础配置。</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">/etc/nginx/nginx.conf</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">user</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">www-data</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">worker_processes</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">auto</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">pid</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/run/nginx.pid</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">error_log</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/var/log/nginx/error.log</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">include</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/nginx/modules-enabled/</span><span style="--0:#79B8FF;--1:#005CC5">*</span><span style="--0:#9ECBFF;--1:#032F62">.conf</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">events</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">worker_connections</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">768</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code"><span class="indent">  </span><span style="--0:#99A0A6;--1:#616972"># multi_accept on;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">12</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">http</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">13</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">sendfile</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">on</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">14</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">tcp_nopush</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">on</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><details class="ec-section"><summary><div class="ec-line"><div class="gutter"><div class="ln"></div></div><div class="code"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 16 16" width="16" height="16"><path d="m8.177.677 2.896 2.896a.25.25 0 0 1-.177.427H8.75v1.25a.75.75 0 0 1-1.5 0V4H5.104a.25.25 0 0 1-.177-.427L7.823.677a.25.25 0 0 1 .354 0ZM7.25 10.75a.75.75 0 0 1 1.5 0V12h2.146a.25.25 0 0 1 .177.427l-2.896 2.896a.25.25 0 0 1-.354 0l-2.896-2.896A.25.25 0 0 1 5.104 12H7.25v-1.25Zm-5-2a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM6 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 6 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM12 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 12 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5Z"></path></svg>16 collapsed lines</div></div></summary><div class="ec-line"><div class="gutter"><div class="ln">15</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">types_hash_max_size</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">2048</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">16</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">17</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">include</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/nginx/mime.types</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">18</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">default_type</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">application/octet-stream</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">19</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">20</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">ssl_protocols</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">TLSv1</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">TLSv1.1</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">TLSv1.2</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">TLSv1.3</span><span style="--0:#E1E4E8;--1:#24292E">; </span><span style="--0:#99A0A6;--1:#616972"># Dropping SSLv3, ref: POODLE</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">21</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">ssl_prefer_server_ciphers</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">on</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">22</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">23</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">access_log</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/var/log/nginx/access.log</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">24</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">gzip</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">on</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">25</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">26</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">include</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/nginx/conf.d/</span><span style="--0:#79B8FF;--1:#005CC5">*</span><span style="--0:#9ECBFF;--1:#032F62">.conf</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">27</div></div><div class="code"><span class="indent">  </span><span style="--0:#B392F0;--1:#6F42C1">include</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/nginx/sites-enabled/</span><span style="--0:#79B8FF;--1:#005CC5">*</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">28</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">29</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">30</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">include</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/nginx/vps.conf</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div></details></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="user www-data;worker_processes auto;pid /run/nginx.pid;error_log /var/log/nginx/error.log;include /etc/nginx/modules-enabled/*.conf;events {  worker_connections 768;  # multi_accept on;}http {  sendfile on;  tcp_nopush on;  types_hash_max_size 2048;  include /etc/nginx/mime.types;  default_type application/octet-stream;  ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE  ssl_prefer_server_ciphers on;  access_log /var/log/nginx/access.log;  gzip on;  include /etc/nginx/conf.d/*.conf;  include /etc/nginx/sites-enabled/*;}include /etc/nginx/vps.conf;"><div></div></button></div></figure></div>
<p>　　在 <code>/etc/nginx</code>​ 下创建文件 <code>vps.conf</code>​，并填入下列分流规则：</p>
<ol>
<li>根据域名分流将 443 端口的 https 流量分流到不同的后端。其中 xui 本身支持 https，不需要对 https 解密再转发。而 substore 目前只支持 http，所以需要将 sub 流量转发到 nginx server，由 nginx server 解密再转发到 sub 的端口。除此之外的流量，都转发到 hysteria 的伪装端口。</li>
<li>后续会在 /etc/nginx/sites-enabled/vps.conf 中为 substore 配置一个 nginx 反代服务，其监听的是 8444 端口，因此这里需要将 sub 对应的流量分流至 8444。</li>
<li>xui 端口为 11080，这在 xui 面板搭建一节中提到过，是用户安装时自行设置的。</li>
<li>hysteria 则是在配置文件中设置了伪装服务端口为 8443。</li>
</ol>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">/etc/nginx/vps.conf</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">stream</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972"># 定义一个映射，将 SNI 中的服务器名映射到后端标识符</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">map</span><span style="--0:#E1E4E8;--1:#24292E"> $ssl_preread_server_name $backend </span><span style="--0:#9ECBFF;--1:#032F62">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">hostnames</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">sub.xyz.top</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sub</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">xui.xyz.top</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">xui</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">default</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria</span><span style="--0:#E1E4E8;--1:#24292E">;  </span><span style="--0:#99A0A6;--1:#616972"># 默认后端</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972"># 定义各个后端的上游服务器</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">upstream</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sub</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">12</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">server</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">127.0.0.1:8444</span><span style="--0:#E1E4E8;--1:#24292E">;  </span><span style="--0:#99A0A6;--1:#616972"># sub.xyz.top 对应的后端，对接的是 nginx server</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">13</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><details class="ec-section"><summary><div class="ec-line"><div class="gutter"><div class="ln"></div></div><div class="code"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 16 16" width="16" height="16"><path d="m8.177.677 2.896 2.896a.25.25 0 0 1-.177.427H8.75v1.25a.75.75 0 0 1-1.5 0V4H5.104a.25.25 0 0 1-.177-.427L7.823.677a.25.25 0 0 1 .354 0ZM7.25 10.75a.75.75 0 0 1 1.5 0V12h2.146a.25.25 0 0 1 .177.427l-2.896 2.896a.25.25 0 0 1-.354 0l-2.896-2.896A.25.25 0 0 1 5.104 12H7.25v-1.25Zm-5-2a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM6 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 6 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM12 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 12 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5Z"></path></svg>17 collapsed lines</div></div></summary><div class="ec-line"><div class="gutter"><div class="ln">14</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">15</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">upstream</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">xui</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">16</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">server</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">127.0.0.1:11080</span><span style="--0:#E1E4E8;--1:#24292E">;  </span><span style="--0:#99A0A6;--1:#616972"># xui.xyz.top 对应的后端</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">17</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">18</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">19</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">upstream</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">hysteria</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">20</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">server</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">127.0.0.1:8443</span><span style="--0:#E1E4E8;--1:#24292E">;  </span><span style="--0:#99A0A6;--1:#616972"># 默认后端</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">21</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">22</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">23</div></div><div class="code"><span class="indent">    </span><span style="--0:#99A0A6;--1:#616972"># 定义一个服务器块，监听指定端口并根据 SNI 分发流量</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">24</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">server</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">25</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">listen</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">443</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">26</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">listen</span><span style="--0:#E1E4E8;--1:#24292E"> [::]:443;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">27</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">proxy_pass</span><span style="--0:#E1E4E8;--1:#24292E"> $backend;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">28</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">ssl_preread</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">on</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">29</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">30</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div></details></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="stream {    # 定义一个映射，将 SNI 中的服务器名映射到后端标识符    map $ssl_preread_server_name $backend {        hostnames;        sub.xyz.top sub;        xui.xyz.top xui;        default hysteria;  # 默认后端    }    # 定义各个后端的上游服务器    upstream sub {        server 127.0.0.1:8444;  # sub.xyz.top 对应的后端，对接的是 nginx server    }    upstream xui {        server 127.0.0.1:11080;  # xui.xyz.top 对应的后端    }    upstream hysteria {        server 127.0.0.1:8443;  # 默认后端    }    # 定义一个服务器块，监听指定端口并根据 SNI 分发流量    server {        listen 443;        listen [::]:443;        proxy_pass $backend;        ssl_preread on;    }}"><div></div></button></div></figure></div>
<p>　　然后需要设置 sub-store 的 server 反代并部署 SSL 证书用于 tls 认证，解密 https 流量。</p>
<div class="expressive-code"><figure class="frame has-title"><figcaption class="header"><span class="title">/etc/nginx/sites-enabled/vps.conf</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">server</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">listen</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">8444</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">ssl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">http2</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">listen</span><span style="--0:#E1E4E8;--1:#24292E"> [::]:8444 ssl http2;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">4</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">server_name</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sub.xyz.top</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">5</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">6</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">ssl_certificate</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/root/.acme.sh/xyz.top_ecc/fullchain.cer</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">7</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">ssl_certificate_key</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/root/.acme.sh/xyz.top_ecc/xyz.top.key</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">8</div></div><div class="code">
</div></div><div class="ec-line"><div class="gutter"><div class="ln">9</div></div><div class="code"><span class="indent">    </span><span style="--0:#B392F0;--1:#6F42C1">location</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">{</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">10</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">proxy_pass</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">http://127.0.0.1:3001</span><span style="--0:#E1E4E8;--1:#24292E">;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">11</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">proxy_set_header</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">Host</span><span style="--0:#E1E4E8;--1:#24292E"> $host;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">12</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">proxy_set_header</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">X-Real-IP</span><span style="--0:#E1E4E8;--1:#24292E"> $remote_addr;</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">13</div></div><div class="code"><span class="indent">        </span><span style="--0:#B392F0;--1:#6F42C1">proxy_set_header</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">X-Forwarded-For</span><span style="--0:#E1E4E8;--1:#24292E"> $proxy_add_x_forwarded_for;</span></div></div><details class="ec-section"><summary><div class="ec-line"><div class="gutter"><div class="ln"></div></div><div class="code"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" viewBox="0 0 16 16" width="16" height="16"><path d="m8.177.677 2.896 2.896a.25.25 0 0 1-.177.427H8.75v1.25a.75.75 0 0 1-1.5 0V4H5.104a.25.25 0 0 1-.177-.427L7.823.677a.25.25 0 0 1 .354 0ZM7.25 10.75a.75.75 0 0 1 1.5 0V12h2.146a.25.25 0 0 1 .177.427l-2.896 2.896a.25.25 0 0 1-.354 0l-2.896-2.896A.25.25 0 0 1 5.104 12H7.25v-1.25Zm-5-2a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM6 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 6 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5ZM12 8a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5A.75.75 0 0 1 12 8Zm2.25.75a.75.75 0 0 0 0-1.5h-.5a.75.75 0 0 0 0 1.5h.5Z"></path></svg>2 collapsed lines</div></div></summary><div class="ec-line"><div class="gutter"><div class="ln">14</div></div><div class="code"><span class="indent"><span style="--0:#E1E4E8;--1:#24292E">    </span></span><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">15</div></div><div class="code"><span style="--0:#E1E4E8;--1:#24292E">}</span></div></div></details></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="server {    listen 8444 ssl http2;    listen [::]:8444 ssl http2;    server_name sub.xyz.top;    ssl_certificate /root/.acme.sh/xyz.top_ecc/fullchain.cer;    ssl_certificate_key /root/.acme.sh/xyz.top_ecc/xyz.top.key;    location / {        proxy_pass http://127.0.0.1:3001;        proxy_set_header Host $host;        proxy_set_header X-Real-IP $remote_addr;        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;    }}"><div></div></button></div></figure></div>
<h3 id="启动-nginx">启动 nginx</h3>
<p>　　移除默认的配置文件：<code>sudo rm /etc/nginx/sites-enabled/default</code>​。如果 <code>/etc/nginx/sites-enabled</code>​ 有其他的配置文件，都会被 nginx 启动，因此为了防止冲突，需要移除。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nginx</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># 检测配置是否正确</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">systemctl</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">restart</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nginx</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nginx</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-s</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">reload</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#99A0A6;--1:#616972"># 重新启动 nginx</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="sudo nginx -t # 检测配置是否正确sudo systemctl restart nginxsudo nginx -s reload # 重新启动 nginx"><div></div></button></div></figure></div>
<p>　　如果出现下列错误 <code>unknown directive "stream"</code>​，则是缺少 stream 的支持库，安装即可 <code>sudo apt install libnginx-mod-stream</code>​。这可能是由于 nginx v20.18.0 版本较低，v22.13.0 版本没有该问题。</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">$</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">sudo</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">nginx</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#79B8FF;--1:#005CC5">-t</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">2</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">2024/12/19</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">16:53:58</span><span style="--0:#E1E4E8;--1:#24292E"> [emerg] 1424878#1424878: unknown directive </span><span style="--0:#9ECBFF;--1:#032F62">"stream"</span><span style="--0:#E1E4E8;--1:#24292E"> in /etc/nginx/vps.conf:2</span></div></div><div class="ec-line"><div class="gutter"><div class="ln">3</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">nginx:</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">configuration</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">file</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">/etc/nginx/nginx.conf</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">test</span><span style="--0:#E1E4E8;--1:#24292E"> </span><span style="--0:#9ECBFF;--1:#032F62">failed</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="$ sudo nginx -t2024/12/19 16:53:58 [emerg] 1424878#1424878: unknown directive &#x22;stream&#x22; in /etc/nginx/vps.conf:2nginx: configuration file /etc/nginx/nginx.conf test failed"><div></div></button></div></figure></div>
<h3 id="访问服务">访问服务</h3>
<p>　　在搭建好 nginx 反代后，就可以通过域名直接用 https 访问对应的服务了，不需要像之前一样，输入 ip+端口号的形式来访问。大大提高了安全性和易用性。</p>
<h4 id="访问-substore">访问 SubStore</h4>
<p>　　设置好后，SubStore 地址为：<code>https://sub.xyz.top</code>​</p>
<p>　　其后端 API 为（可以在 mihomo-party 中添加），也可以直接在前端的设置中填入。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">https://sub.xyz.top/2cXaAxRGfddmGz2yx1wA</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="https://sub.xyz.top/2cXaAxRGfddmGz2yx1wA"><div></div></button></div></figure></div>
<p>　　浏览器访问带有后端功能的前端，输入</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#e1e4e8;--1:#24292e">https://sub.xyz.top?api=https://sub.xyz.top/2cXaAxRGfddmGz2yx1wA</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="https://sub.xyz.top?api=https://sub.xyz.top/2cXaAxRGfddmGz2yx1wA"><div></div></button></div></figure></div>
<p>　　或者访问前端，在设置中，保存后端的 api。</p>
<h4 id="访问-xui">访问 xui</h4>
<p>　　首先在 cloudflare 中，设置一个三级域名，并解析到服务器 ip，且关闭代理。</p>
<p>　　假设三级域名是：xui.hyperds.com，则现在可以通过</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><div class="gutter"><div class="ln">1</div></div><div class="code"><span style="--0:#B392F0;--1:#6F42C1">https://xui.hyperds.com/5I1Q</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="https://xui.hyperds.com/5I1Q"><div></div></button></div></figure></div>
<p>　　直接访问。</p>
<h4 id="访问其他网址">访问其他网址</h4>
<p>　　除了上述 xui、sub以外的域名，都会被发送到 hysteria 伪装端口，返回的就是伪装的网站。</p>
<h2 id="sub-store-的使用">sub-store 的使用</h2>
<p>　　我在另一个贴子中有详细介绍：<a href="https://linux.do/t/topic/333959/3">节点的订阅管理\分享-我的方案</a></p>
<p>　　‍</p> </article> <div class="divider-horizontal"></div> <div class="h-8 text-skin-base"> <a class="truncate  w-auto max-w-[40%] float-left" href="/blog/proxy/自建服务器使用" title="自建服务器使用"> <i class="ri-arrow-left-s-fill"></i> 自建服务器使用 </a> <div class="flex item-center float-right w-auto max-w-[40%] text-right"> <a class="truncate " href="/blog/linux-多线程压缩与解压缩" title="Linux 多线程压缩与解压缩"> Linux 多线程压缩与解压缩 </a> <i class="ri-arrow-right-s-fill float-right"></i> </div> </div> <div class="border-l-4 my-4 p-4 border-l-skin-base bg-skin-card break-all"> <div>本文标题：年轻人的第一台 VPS 代理服务器</div> <div>文章作者：Lyndra</div> <div>发布时间：2024-12-20</div> <div> 原始链接：<a href="https://www.hysling.top/blog/proxy/年轻人的第一台-vps-代理服务器" class="hover:text-skin-active">https://www.hysling.top/blog/proxy/年轻人的第一台-vps-代理服务器</a> </div> </div>  </div>  <div class="giscus"></div> <script src="https://giscus.app/client.js" data-repo="codetang-2417/codetang-2417.github.io" data-repo-id="R_kgDOMyu4sg" data-category="Announcements" data-category-id="DIC_kwDOMyu4ss4CiiW6" data-mapping="title" data-strict="light" data-reactions-enabled="dark" data-emit-metadata="1" data-input-position="0" data-theme="light" data-lang="zh-CN" crossorigin="anonymous"></script> </div> <div class="hidden xl:block col-span-1 relative"> <div class="shadow-lg rounded-lg h-64 w-auto flex flex-col items-center justify-center bg-skin-card p-2"> <img class="avatar mb-4" src="/avatar.svg" alt="avatar"> <div class="mb-2 text-center">本来无一物，何处惹尘埃</div> <div class="flex items-center justify-center flex-wrap"> <a title="github" href="https://github.com/codetang-2417" target="_blank"> <i class="ri-github-fill text-2xl mr-2 cursor-pointer"></i> </a><a title="rss" href target="_blank"> <i class="ri-rss-fill text-2xl mr-2 cursor-pointer"></i> </a> </div> </div> <div id="toc" class="shadow-lg rounded-lg my-4 py-2 px-2 bg-skin-card sticky top-20" data-astro-cid-6t6zfk7k> <div class="aside-widget" data-astro-cid-6t6zfk7k> <i class="ri-list-check menu-icon" data-astro-cid-6t6zfk7k></i> 文章目录 </div> <div class="overflow-auto" data-astro-cid-6t6zfk7k> <div class="toc-container" data-astro-cid-6t6zfk7k></div> </div> </div>  <script type="module" src="/_astro/Toc.astro_astro_type_script_index_0_lang.R6DO86cs.js"></script> </div> <button type="button" id="scrollToTopBtn" class="header-btn fixed bottom-4 right-2 hidden" title="scroll to top"> <i class="ri-arrow-up-line"></i> </button> <script type="module">let o=document.getElementById("scrollToTopBtn");window.addEventListener("scroll",function(){window.scrollY>200?o.style.display="block":o.style.display="none"});o.addEventListener("click",function(){window.scrollTo({top:0,behavior:"smooth"})});</script> </div> <div class="h-16 container p-1 absolute left-0 bottom-0"> <div class="flex items-center justify-center text-skin-base"> <span id="busuanzi_container_site_pv"> 总访问量<span id="busuanzi_value_site_pv"></span>次 </span> <div class="divider-vertical"></div> <span id="busuanzi_container_site_uv"> 总访客数<span id="busuanzi_value_site_uv"></span>人次 </span> </div> <div class="flex items-center flex-col flex-wrap justify-center mb-4 text-skin-base first:mb-0 sm:flex-row"> <div> <span class="cursor-default">Copyright</span> <i class="ri-copyright-line align-middle"></i> <span class="align-middle">2025</span> </div>  <div class="divider-vertical"></div> <a href="/sitemap-0.xml">站点地图</a> </div> </div> </main> <script type="module" src="/_astro/BlogPost.astro_astro_type_script_index_0_lang.C_bBgou1.js"></script></body></html>